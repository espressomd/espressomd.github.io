<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>19. Reaction methods &#8212; ESPResSo 5.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=97504538" />
    <link rel="stylesheet" type="text/css" href="_static/blockquotes.css?v=270de11a" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css?v=539bf778" />
    <script src="_static/documentation_options.js?v=ce74c6a2"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/toggleprompt.js?v=5801b3bb"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="20. Under the hood" href="under_the_hood.html" />
    <link rel="prev" title="18. Advanced methods" href="advanced_methods.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="reaction-methods">
<span id="id1"></span><h1><span class="section-number">19. </span>Reaction methods<a class="headerlink" href="#reaction-methods" title="Link to this heading">¶</a></h1>
<p>This chapter describes methods for simulating chemical reaction equilibria
using reactive particles. Chemical species are referred to by an integer value
stored in the particle <a class="reference internal" href="espressomd.html#espressomd.particle_data.ParticleHandle.type" title="espressomd.particle_data.ParticleHandle.type"><code class="xref py py-attr docutils literal notranslate"><span class="pre">type</span></code></a>
property. Chemical reactions take place by changing the value in the
<a class="reference internal" href="espressomd.html#espressomd.particle_data.ParticleHandle.type" title="espressomd.particle_data.ParticleHandle.type"><code class="xref py py-attr docutils literal notranslate"><span class="pre">type</span></code></a> property via Monte Carlo
moves using the potential energy of the system before and after the reaction
<span id="id2">[<a class="reference internal" href="bibliography.html#id122" title="C. Heath Turner, John K. Brennan, Martin Lísal, William R. Smith, J. Karl Johnson, and Keith E. Gubbins. Simulation of chemical reaction equilibria by the reaction ensemble Monte Carlo method: A review. Molecular Simulation, 34(2):119–146, 2008. doi:10.1080/08927020801986564.">Turner <em>et al.</em>, 2008</a>]</span>.</p>
<p>For a description of the common functionality of all reaction methods,
see <a class="reference internal" href="espressomd.html#espressomd.reaction_methods.ReactionAlgorithm" title="espressomd.reaction_methods.ReactionAlgorithm"><code class="xref py py-class docutils literal notranslate"><span class="pre">espressomd.reaction_methods.ReactionAlgorithm</span></code></a>.</p>
<p>Please keep in mind the following remarks:</p>
<ul class="simple">
<li><p>All reaction methods uses Monte Carlo moves which require potential energies.
Therefore reaction methods require support for energy calculations for all
active interactions in the simulation. Some algorithms do not support energy
calculation, e.g. <a class="reference internal" href="advanced_methods.html#object-in-fluid"><span class="std std-ref">OIF</span></a> and
<a class="reference internal" href="advanced_methods.html#immersed-boundary-method-for-soft-elastic-objects"><span class="std std-ref">IBM</span></a>.</p></li>
<li><p>When modeling reactions that do not conserve the number of particles, the
method has to create or delete particles from the system. This process can
invalidate particle ids, in which case the particles are no longer numbered
contiguously. Particle slices returned by <code class="docutils literal notranslate"><span class="pre">system.part</span></code> are still iterable,
but the indices no longer match the particle ids.</p></li>
<li><p>Checkpointing is not supported, since the state of the Mersenne Twister
random number generator cannot be serialized.</p></li>
<li><p>For improved performance, you can set the type of invalidated particles with
<a class="reference internal" href="espressomd.html#espressomd.reaction_methods.ReactionAlgorithm.set_non_interacting_type" title="espressomd.reaction_methods.ReactionAlgorithm.set_non_interacting_type"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_non_interacting_type()</span></code></a>
in all reaction method classes.</p></li>
<li><p>Some of the functionality requires particle book-keeping. If your simulation
script raises runtime errors about “provided particle type X is currently not
tracked by the system”, use <a class="reference internal" href="espressomd.html#espressomd.system.System.setup_type_map" title="espressomd.system.System.setup_type_map"><code class="xref py py-meth docutils literal notranslate"><span class="pre">system.setup_type_map(type_list=[X])</span></code></a> where <code class="docutils literal notranslate"><span class="pre">X</span></code> is the particle
type to track.</p></li>
</ul>
<section id="thermodynamic-ensembles">
<h2><span class="section-number">19.1. </span>Thermodynamic ensembles<a class="headerlink" href="#thermodynamic-ensembles" title="Link to this heading">¶</a></h2>
<section id="reaction-ensemble">
<span id="id3"></span><h3><span class="section-number">19.1.1. </span>Reaction ensemble<a class="headerlink" href="#reaction-ensemble" title="Link to this heading">¶</a></h3>
<p>The reaction ensemble <span id="id4">[<a class="reference internal" href="bibliography.html#id65" title="J. Karl Johnson, Athanassios Z. Panagiotopoulos, and Keith E. Gubbins. Reactive canonical Monte Carlo: A new simulation technique for reacting or associating fluids. Molecular Physics, 81(3):717–733, 1994. doi:10.1080/00268979400100481.">Johnson <em>et al.</em>, 1994</a>, <a class="reference internal" href="bibliography.html#id110" title="W. R. Smith and B. Triska. The reaction ensemble method for the computer simulation of chemical and phase equilibria. I. Theory and basic examples. The Journal of Chemical Physics, 100(4):3019–3027, 1994. doi:10.1063/1.466443.">Smith and Triska, 1994</a>, <a class="reference internal" href="bibliography.html#id122" title="C. Heath Turner, John K. Brennan, Martin Lísal, William R. Smith, J. Karl Johnson, and Keith E. Gubbins. Simulation of chemical reaction equilibria by the reaction ensemble Monte Carlo method: A review. Molecular Simulation, 34(2):119–146, 2008. doi:10.1080/08927020801986564.">Turner <em>et al.</em>, 2008</a>]</span> allows to simulate
chemical reactions which can be represented by the general equation:</p>
<div class="math notranslate nohighlight">
\[\mathrm{\nu_1 S_1 +\ \dots\  \nu_l S_l\ \rightleftharpoons\ \nu_m S_m +\ \dots\ \nu_z S_z }
    \label{general-eq}\]</div>
<p>where <span class="math notranslate nohighlight">\(\nu_i\)</span> is the stoichiometric coefficient of species
<span class="math notranslate nohighlight">\(S_i\)</span>. By convention, stoichiometric coefficients of the
species on the left-hand side of the reaction (<em>reactants</em>) attain
negative values, and those on the right-hand side (<em>products</em>) attain
positive values, so that the reaction can be equivalently written as</p>
<div class="math notranslate nohighlight">
\[\mathrm{\sum_i \nu_i S_i = 0} \,.
    \label{general-eq-sum}\]</div>
<p>The equilibrium constant of the reaction is then given as</p>
<div class="math notranslate nohighlight">
\[K = \exp(-\Delta_{\mathrm{r}}G^{\ominus} / k_B T)
    \quad\text{with}\quad
    \Delta_{\mathrm{r}}G^{\ominus} = \sum_i \nu_i \mu_i^{\ominus}\,.
    \label{Keq}\]</div>
<p>Here <span class="math notranslate nohighlight">\(k_B\)</span> is the Boltzmann constant, <span class="math notranslate nohighlight">\(T\)</span> is temperature,
<span class="math notranslate nohighlight">\(\Delta_{\mathrm{r}}G^{\ominus}\)</span> standard Gibbs free energy change
of the reaction, and <span class="math notranslate nohighlight">\(\mu_i^{\ominus}\)</span> the standard chemical
potential (per particle) of species <span class="math notranslate nohighlight">\(i\)</span>. Note that thermodynamic equilibrium is
independent of the direction in which we write the reaction. If it is
written with left and right-hand side swapped,
both <span class="math notranslate nohighlight">\(\Delta_{\mathrm{r}}G^{\ominus}\)</span> and the stoichiometric
coefficients attain opposite signs, and the equilibrium constant attains the inverse value.
Further, note that the equilibrium constant <span class="math notranslate nohighlight">\(K\)</span> is the
dimensionless <em>thermodynamic, concentration-based</em> equilibrium constant,
defined as</p>
<div class="math notranslate nohighlight">
\[K(c^{\ominus}) = (c^{\ominus})^{-\bar\nu} \prod_i (c_i)^{\nu_i}\]</div>
<p>where <span class="math notranslate nohighlight">\(\bar\nu=\sum_i \nu_i\)</span>, and <span class="math notranslate nohighlight">\(c^{\ominus}\)</span> is the reference concentration,
at which the standard chemical potential <span class="math notranslate nohighlight">\(\Delta_{\mathrm{r}}G^{\ominus}\)</span> was determined.
In practice, this constant is often used with the dimension of <span class="math notranslate nohighlight">\((c^{\ominus})^{\bar\nu}\)</span></p>
<div class="math notranslate nohighlight">
\[K_c(c^{\ominus}) = K(c^{\ominus})\times (c^{\ominus})^{\bar\nu}\]</div>
<p>A simulation in
the reaction ensemble consists of two types of moves: the <em>reaction move</em>
and the <em>configuration move</em>. The configuration move changes the configuration
of the system.
In the <em>forward</em> reaction, the appropriate number of reactants (given by
<span class="math notranslate nohighlight">\(\nu_i\)</span>) is removed from the system, and the concomitant number of
products is inserted into the system. In the <em>backward</em> reaction,
reactants and products exchange their roles. The acceptance probability
<span class="math notranslate nohighlight">\(P^{\xi}\)</span> for a move from state <span class="math notranslate nohighlight">\(o\)</span> to <span class="math notranslate nohighlight">\(n\)</span> in the reaction
ensemble is given by the criterion <span id="id5">[<a class="reference internal" href="bibliography.html#id110" title="W. R. Smith and B. Triska. The reaction ensemble method for the computer simulation of chemical and phase equilibria. I. Theory and basic examples. The Journal of Chemical Physics, 100(4):3019–3027, 1994. doi:10.1063/1.466443.">Smith and Triska, 1994</a>]</span></p>
<div class="math notranslate nohighlight">
\[P^{\xi} = \text{min}\biggl(1,V^{\bar\nu\xi}\Gamma^{\xi}e^{-\beta\Delta E}\prod_{i=1}\frac{N_i^0!}{(N_i^0+\nu_{i}\xi)!}
    \label{eq:Pacc}
    \biggr),\]</div>
<p>where <span class="math notranslate nohighlight">\(\Delta E=E_\mathrm{new}-E_\mathrm{old}\)</span> is the change in potential energy,
<span class="math notranslate nohighlight">\(V\)</span> is the simulation box volume,
<span class="math notranslate nohighlight">\(\beta=1/k_\mathrm{B}T\)</span> is the Boltzmann factor, and
<span class="math notranslate nohighlight">\(\xi\)</span> is the extent of reaction, with <span class="math notranslate nohighlight">\(\xi=1\)</span> for the forward and
<span class="math notranslate nohighlight">\(\xi=-1\)</span> for the backward direction.</p>
<p><span class="math notranslate nohighlight">\(\Gamma\)</span> is proportional to the reaction constant. It is defined as</p>
<div class="math notranslate nohighlight">
\[\Gamma = \prod_i \Bigl(\frac{\left&lt;N_i\right&gt;}{V} \Bigr)^{\bar\nu} = V^{-\bar\nu} \prod_i \left&lt;N_i\right&gt;^{\nu_i} = K_c(c^{\ominus}=1/\sigma^3)\]</div>
<p>where <span class="math notranslate nohighlight">\(\left&lt;N_i\right&gt;/V\)</span> is the average number density of particles of type <span class="math notranslate nohighlight">\(i\)</span>.
Note that the dimension of <span class="math notranslate nohighlight">\(\Gamma\)</span> is <span class="math notranslate nohighlight">\(V^{\bar\nu}\)</span>, therefore its
units must be consistent with the units in which ESPResSo measures the box volume,
i.e. <span class="math notranslate nohighlight">\(\sigma^3\)</span>.</p>
<p>It is often convenient, and in some cases even necessary, that some particles
representing reactants are not removed from or placed at randomly in the system
but their identity is changed to that of the products, or vice versa in the
backward direction.  A typical example is the ionization reaction of weak
polyelectrolytes, where the ionizable groups on the polymer have to remain on
the polymer chain after the reaction.  The replacement rule is that the identity of a given reactant type is
changed to the corresponding product type as long as the corresponding
coefficients allow for it.  Corresponding means having the same position (index) in
the python lists of reactants and products which are used to set up the
reaction.</p>
<p>Multiple reactions can be added to the same instance of the reaction ensemble.</p>
<p>An example script can be found here:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/espressomd/espresso/blob/python/samples/reaction_methods.py">Reaction ensemble / constant pH ensemble</a></p></li>
</ul>
<p>For a description of the available methods, see <a class="reference internal" href="espressomd.html#espressomd.reaction_methods.ReactionEnsemble" title="espressomd.reaction_methods.ReactionEnsemble"><code class="xref py py-class docutils literal notranslate"><span class="pre">espressomd.reaction_methods.ReactionEnsemble</span></code></a>.</p>
</section>
<section id="grand-canonical-ensemble">
<span id="id6"></span><h3><span class="section-number">19.1.2. </span>Grand canonical ensemble<a class="headerlink" href="#grand-canonical-ensemble" title="Link to this heading">¶</a></h3>
<p>As a special case, all stoichiometric coefficients on one side of the chemical
reaction can be set to zero. Such a reaction creates particles <em>ex nihilo</em>, and
is equivalent to exchanging particles with a reservoir. This type of simulation
in the reaction ensemble is equivalent to the grand canonical simulation.
Formally, this can be expressed by the reaction</p>
<div class="math notranslate nohighlight">
\[\mathrm{\emptyset \rightleftharpoons\ \nu_A A  }  \,,\]</div>
<p>where, if <span class="math notranslate nohighlight">\(\nu_A=1\)</span>, the reaction constant <span class="math notranslate nohighlight">\(\Gamma\)</span> defines the chemical potential of species A.
However, if <span class="math notranslate nohighlight">\(\nu_A\neq 1\)</span>, the statistics of the reaction ensemble becomes
equivalent to the grand canonical only in the limit of large average number of species A in the box.
If the reaction contains more than one product, then the reaction constant
<span class="math notranslate nohighlight">\(\Gamma\)</span> defines only the sum of their chemical potentials but not the
chemical potential of each product alone.</p>
<p>Since the Reaction Ensemble acceptance transition probability can be
derived from the grand canonical acceptance transition probability, we
can use the reaction ensemble to implement grand canonical simulation
moves. This is done by adding reactions that only have reactants (for the
deletion of particles) or only have products (for the creation of
particles). There exists a one-to-one mapping of the expressions in the
grand canonical transition probabilities and the expressions in the
reaction ensemble transition probabilities.</p>
</section>
<section id="constant-ph">
<span id="id7"></span><h3><span class="section-number">19.1.3. </span>Constant pH<a class="headerlink" href="#constant-ph" title="Link to this heading">¶</a></h3>
<p>As before in the reaction ensemble, one can define multiple reactions (e.g. for an ampholytic system which contains an acid and a base) in one <a class="reference internal" href="espressomd.html#espressomd.reaction_methods.ConstantpHEnsemble" title="espressomd.reaction_methods.ConstantpHEnsemble"><code class="xref py py-class docutils literal notranslate"><span class="pre">ConstantpHEnsemble</span></code></a> instance:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cpH</span> <span class="o">=</span> <span class="n">reaction_methods</span><span class="o">.</span><span class="n">ConstantpHEnsemble</span><span class="p">(</span><span class="n">kT</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">exclusion_range</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">77</span><span class="p">)</span>
<span class="n">cpH</span><span class="o">.</span><span class="n">add_reaction</span><span class="p">(</span><span class="n">gamma</span><span class="o">=</span><span class="n">K_diss</span><span class="p">,</span>
                 <span class="n">reactant_types</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">reactant_coefficients</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">product_types</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                 <span class="n">product_coefficients</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                 <span class="n">default_charges</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="o">+</span><span class="mi">1</span><span class="p">})</span>
<span class="n">cpH</span><span class="o">.</span><span class="n">add_reaction</span><span class="p">(</span><span class="n">gamma</span><span class="o">=</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">10</span><span class="o">**-</span><span class="mi">14</span><span class="o">/</span><span class="n">K_diss</span><span class="p">),</span>
                 <span class="n">reactant_types</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
                 <span class="n">reactant_coefficients</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">product_types</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                 <span class="n">product_coefficients</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                 <span class="n">default_charges</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">:</span><span class="mi">1</span><span class="p">})</span>
</pre></div>
</div>
<p>An example script can be found here:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/espressomd/espresso/blob/python/samples/reaction_methods.py">Reaction ensemble / constant pH ensemble</a></p></li>
</ul>
<p>In the constant pH method due to Reed and Reed
<span id="id9">[<a class="reference internal" href="bibliography.html#id102" title="Christopher E. Reed and Wayne F. Reed. Monte Carlo study of titration of linear polyelectrolytes. The Journal of Chemical Physics, 96(2):1609–1620, 1992. doi:10.1063/1.462145.">Reed and Reed, 1992</a>]</span> it is possible to set the chemical potential
of <span class="math notranslate nohighlight">\(H^{+}\)</span> ions, assuming that the simulated system is coupled to an
infinite reservoir. This value is the used to simulate dissociation
equilibrium of acids and bases. Under certain conditions, the constant
pH method can yield equivalent results as the reaction ensemble <span id="id10">[<a class="reference internal" href="bibliography.html#id76" title="Jonas Landsgesell, Christian Holm, and Jens Smiatek. Simulation of weak polyelectrolytes: A comparison between the constant pH and the reaction ensemble method. European Physical Journal Special Topics, 226(4):725–736, 2017. doi:10.1140/epjst/e2016-60324-3.">Landsgesell <em>et al.</em>, 2017</a>]</span>. However, it
treats the chemical potential of <span class="math notranslate nohighlight">\(H^{+}\)</span> ions and their actual
number in the simulation box as independent variables, which can lead to
serious artifacts.
The constant pH method can be used within the reaction ensemble module by
initializing the reactions with the standard commands of the reaction ensemble.</p>
<p>The dissociation constant, which is the input of the constant pH method, is the equilibrium
constant <span class="math notranslate nohighlight">\(K_c\)</span> for the following reaction:</p>
<div class="math notranslate nohighlight">
\[\mathrm{HA \rightleftharpoons\ H^+ + A^- } \,,\]</div>
<p>For a description of the available methods, see <a class="reference internal" href="espressomd.html#espressomd.reaction_methods.ConstantpHEnsemble" title="espressomd.reaction_methods.ConstantpHEnsemble"><code class="xref py py-class docutils literal notranslate"><span class="pre">espressomd.reaction_methods.ConstantpHEnsemble</span></code></a>.</p>
</section>
<section id="widom-insertion-for-homogeneous-systems">
<h3><span class="section-number">19.1.4. </span>Widom Insertion (for homogeneous systems)<a class="headerlink" href="#widom-insertion-for-homogeneous-systems" title="Link to this heading">¶</a></h3>
<p>The Widom insertion method <span id="id11">[<a class="reference internal" href="bibliography.html#id131" title="B. Widom. Some topics in the theory of fluids. The Journal of Chemical Physics, 39(11):2802–2812, 1963. doi:10.1063/1.1734110.">Widom, 1963</a>]</span> measures the change in excess free energy, i.e. the excess chemical potential due to the insertion of a new particle, or a group of particles:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mu^\mathrm{ex}_B &amp; :=\Delta F^\mathrm{ex} =F^\mathrm{ex}(N_B+1,V,T)-F^\mathrm{ex}(N_B,V,T)\\
&amp;=-kT \ln \left(\frac{1}{V} \int_V d^3r_{N_B+1} \langle \exp(-\beta \Delta E_\mathrm{pot}) \rangle_{N_B} \right)\end{split}\]</div>
<p>For this one has to provide the following reaction to the Widom method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">type_B</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">widom</span> <span class="o">=</span> <span class="n">reaction_methods</span><span class="o">.</span><span class="n">WidomInsertion</span><span class="p">(</span><span class="n">kT</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">77</span><span class="p">)</span>
<span class="n">widom</span><span class="o">.</span><span class="n">add_reaction</span><span class="p">(</span><span class="n">reactant_types</span><span class="o">=</span><span class="p">[],</span>
                   <span class="n">reactant_coefficients</span><span class="o">=</span><span class="p">[],</span>
                   <span class="n">product_types</span><span class="o">=</span><span class="p">[</span><span class="n">type_B</span><span class="p">],</span>
                   <span class="n">product_coefficients</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                   <span class="n">default_charges</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
<span class="n">widom</span><span class="o">.</span><span class="n">calculate_particle_insertion_potential_energy</span><span class="p">(</span><span class="n">reaction_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>The call of <code class="docutils literal notranslate"><span class="pre">add_reaction</span></code> define the insertion <span class="math notranslate nohighlight">\(\mathrm{\emptyset \to type_B}\)</span> (which is the 0th defined reaction).
Multiple reactions for the insertions of different types can be added to the same <code class="docutils literal notranslate"><span class="pre">WidomInsertion</span></code> instance.
Measuring the excess chemical potential using the insertion method is done by
calling <code class="docutils literal notranslate"><span class="pre">widom.calculate_particle_insertion_potential_energy(reaction_id=0)</span></code>
multiple times and providing the accumulated sample to
<code class="docutils literal notranslate"><span class="pre">widom.calculate_excess_chemical_potential(particle_insertion_potential_energy_samples=samples)</span></code>.
If another particle insertion is defined, then the excess chemical potential
for this insertion can be measured in a similar fashion by sampling
<code class="docutils literal notranslate"><span class="pre">widom.calculate_particle_insertion_potential_energy(reaction_id=1)</span></code>.
Be aware that the implemented method only works for the canonical ensemble. If the numbers of particles fluctuate (i.e. in a semi grand canonical simulation) one has to adapt the formulas from which the excess chemical potential is calculated! This is not implemented. Also in a isobaric-isothermal simulation (NpT) the corresponding formulas for the excess chemical potentials need to be adapted. This is not implemented.</p>
<p>The implementation can also deal with the simultaneous insertion of multiple particles and can therefore measure the change of excess free energy of multiple particles like e.g.:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mu^\mathrm{ex, pair}&amp;:=\Delta F^\mathrm{ex, pair}:= F^\mathrm{ex}(N_1+1, N_2+1,V,T)-F^\mathrm{ex}(N_1, N_2 ,V,T)\\
&amp;=-kT \ln \left(\frac{1}{V^2} \int_V \int_V d^3r_{N_1+1} d^3 r_{N_2+1} \langle \exp(-\beta \Delta E_\mathrm{pot}) \rangle_{N_1, N_2} \right)\end{split}\]</div>
<p>Note that the measurement involves three averages: the canonical ensemble average <span class="math notranslate nohighlight">\(\langle \cdot \rangle_{N_1, N_2}\)</span> and the two averages over the position of particles <span class="math notranslate nohighlight">\(N_1+1\)</span> and <span class="math notranslate nohighlight">\(N_2+1\)</span>.
Since the averages over the position of the inserted particles are obtained via brute force sampling of the insertion positions it can be beneficial to have multiple insertion tries on the same configuration of the other particles.</p>
<p>One can measure the change in excess free energy due to the simultaneous insertions of particles of type 1 and 2 and the simultaneous removal of a particle of type 3:</p>
<div class="math notranslate nohighlight">
\[\mu^\mathrm{ex}:=\Delta F^\mathrm{ex, }:= F^\mathrm{ex}(N_1+1, N_2+1, N_3-1,V,T)-F^\mathrm{ex}(N_1, N_2, N_3 ,V,T)\]</div>
<p>For this one has to provide the following reaction to the Widom method:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">widom</span><span class="o">.</span><span class="n">add_reaction</span><span class="p">(</span><span class="n">reactant_types</span><span class="o">=</span><span class="p">[</span><span class="n">type_3</span><span class="p">],</span>
                   <span class="n">reactant_coefficients</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                   <span class="n">product_types</span><span class="o">=</span><span class="p">[</span><span class="n">type_1</span><span class="p">,</span> <span class="n">type_2</span><span class="p">],</span>
                   <span class="n">product_coefficients</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                   <span class="n">default_charges</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
<span class="n">widom</span><span class="o">.</span><span class="n">calculate_particle_insertion_potential_energy</span><span class="p">(</span><span class="n">reaction_id</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>Be aware that in the current implementation, for MC moves which add
and remove particles, the insertion of the new particle always takes
place at the position where the last particle was removed. Be sure
that this is the behavior you want to have. Otherwise implement a new
function <code class="docutils literal notranslate"><span class="pre">WidomInsertion::make_reaction_attempt</span></code> in the core.</p>
<p>An example script which demonstrates how to measure the pair excess
chemical potential for inserting an ion pair into a salt solution
can be found here:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/espressomd/espresso/blob/python/samples/widom_insertion.py">Widom Insertion</a></p></li>
</ul>
<p>For a description of the available methods, see <a class="reference internal" href="espressomd.html#espressomd.reaction_methods.WidomInsertion" title="espressomd.reaction_methods.WidomInsertion"><code class="xref py py-class docutils literal notranslate"><span class="pre">espressomd.reaction_methods.WidomInsertion</span></code></a>.</p>
</section>
</section>
<section id="practical-considerations">
<h2><span class="section-number">19.2. </span>Practical considerations<a class="headerlink" href="#practical-considerations" title="Link to this heading">¶</a></h2>
<section id="converting-tabulated-reaction-constants-to-internal-units-in-es">
<span id="converting-tabulated-reaction-constants-to-internal-units-in-espresso"></span><h3><span class="section-number">19.2.1. </span>Converting tabulated reaction constants to internal units in ESPResSo<a class="headerlink" href="#converting-tabulated-reaction-constants-to-internal-units-in-es" title="Link to this heading">¶</a></h3>
<p>The implementation in ESPResSo requires that the dimension of <span class="math notranslate nohighlight">\(\Gamma\)</span>
is consistent with the internal unit of volume, <span class="math notranslate nohighlight">\(\sigma^3\)</span>. The tabulated
values of equilibrium constants for reactions in solution, <span class="math notranslate nohighlight">\(K_c\)</span>, typically use
<span class="math notranslate nohighlight">\(c^{\ominus} = 1\,\mathrm{moldm^{-3}}\)</span> as the reference concentration,
and have the dimension of <span class="math notranslate nohighlight">\((c^{\ominus})^{\bar\nu}\)</span>. To be used with ESPResSo, the
value of <span class="math notranslate nohighlight">\(K_c\)</span> has to be converted as</p>
<div class="math notranslate nohighlight">
\[\Gamma = K_c(c^{\ominus} = 1/\sigma^3) = K_c(c^{\ominus} = 1\,\mathrm{moldm^{-3}})
\Bigl( N_{\mathrm{A}}\bigl(\frac{\sigma}{\mathrm{dm}}\bigr)^3\Bigr)^{\bar\nu}\]</div>
<p>where <span class="math notranslate nohighlight">\(N_{\mathrm{A}}\)</span> is the Avogadro number.  For gas-phase reactions,
the pressure-based reaction constant, <span class="math notranslate nohighlight">\(K_p\)</span> is often used, which can
be converted to <span class="math notranslate nohighlight">\(K_c\)</span> as</p>
<div class="math notranslate nohighlight">
\[K_p(p^{\ominus}=1\,\mathrm{atm}) = K_c(c^{\ominus} = 1\,\mathrm{moldm^{-3}}) \biggl(\frac{c^{\ominus}RT}{p^{\ominus}}\biggr)^{\bar\nu},\]</div>
<p>where <span class="math notranslate nohighlight">\(p^{\ominus}=1\,\mathrm{atm}\)</span> is the standard pressure.
Consider using the python module pint for unit conversion.</p>
</section>
<section id="coupling-reaction-methods-to-molecular-dynamics">
<span id="id12"></span><h3><span class="section-number">19.2.2. </span>Coupling reaction methods to molecular dynamics<a class="headerlink" href="#coupling-reaction-methods-to-molecular-dynamics" title="Link to this heading">¶</a></h3>
<p>The Monte Carlo (MC) sampling of the reaction can  be coupled with a configurational sampling using Molecular Dynamics (MD).
For non-interacting systems this coupling is not an issue, but for interacting systems the insertion of new particles
can lead to instabilities in the MD integration ultimately leading to a crash of the simulation.</p>
<p>This integration instabilities can be avoided by defining a distance around the particles which already exist in the system
where new particles will not be inserted, which is defined by the required keyword <code class="docutils literal notranslate"><span class="pre">exclusion_range</span></code>.
This prevents big overlaps with the newly inserted particles, avoiding too big forces between particles, which prevents the MD integration from crashing.
The value of the exclusion range does not affect the limiting result and it only affects the convergence and the stability of the integration.  For interacting systems,
it is usually a good practice to choose the exclusion range such that it is comparable to the diameter of the particles.</p>
<p>If particles with significantly different sizes are present, it is desired to define a different exclusion range for each pair of particle types. This can be done by
defining an exclusion radius per particle type by using the optional argument <code class="docutils literal notranslate"><span class="pre">exclusion_radius_per_type</span></code>. Then, their exclusion range is calculated using
the Lorentz-Berthelot combination rule, <em>i.e.</em> <code class="docutils literal notranslate"><span class="pre">exclusion_range</span> <span class="pre">=</span> <span class="pre">exclusion_radius_per_type[particle_type_1]</span> <span class="pre">+</span> <span class="pre">exclusion_radius_per_type[particle_type_2]</span></code>.
If the exclusion radius of one particle type is not defined, the value of the parameter provided in <code class="docutils literal notranslate"><span class="pre">exclusion_range</span></code> is used by default.
If the value in <code class="docutils literal notranslate"><span class="pre">exclusion_radius_per_type</span></code> is equal to 0, then the exclusion range of that particle type with any other particle is 0.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">19. Reaction methods</a><ul>
<li><a class="reference internal" href="#thermodynamic-ensembles">19.1. Thermodynamic ensembles</a><ul>
<li><a class="reference internal" href="#reaction-ensemble">19.1.1. Reaction ensemble</a></li>
<li><a class="reference internal" href="#grand-canonical-ensemble">19.1.2. Grand canonical ensemble</a></li>
<li><a class="reference internal" href="#constant-ph">19.1.3. Constant pH</a></li>
<li><a class="reference internal" href="#widom-insertion-for-homogeneous-systems">19.1.4. Widom Insertion (for homogeneous systems)</a></li>
</ul>
</li>
<li><a class="reference internal" href="#practical-considerations">19.2. Practical considerations</a><ul>
<li><a class="reference internal" href="#converting-tabulated-reaction-constants-to-internal-units-in-es">19.2.1. Converting tabulated reaction constants to internal units in ESPResSo</a></li>
<li><a class="reference internal" href="#coupling-reaction-methods-to-molecular-dynamics">19.2.2. Coupling reaction methods to molecular dynamics</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018-2023, The ESPResSo project.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>