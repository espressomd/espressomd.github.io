
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>4. Setting up the system &#8212; ESPResSo 4.2.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="_static/blockquotes.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/toggleprompt.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="5. Setting up particles" href="particles.html" />
    <link rel="prev" title="3. Running a simulation" href="running.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="setting-up-the-system">
<span id="id1"></span><h1><span class="section-number">4. </span>Setting up the system<a class="headerlink" href="#setting-up-the-system" title="Permalink to this headline">¶</a></h1>
<section id="setting-global-variables">
<span id="id2"></span><h2><span class="section-number">4.1. </span>Setting global variables<a class="headerlink" href="#setting-global-variables" title="Permalink to this headline">¶</a></h2>
<p>The global system variables are controlled via the Python
<a class="reference internal" href="espressomd.html#espressomd.system.System" title="espressomd.system.System"><code class="xref py py-class docutils literal notranslate"><span class="pre">espressomd.system.System</span></code></a> class:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">espressomd</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">espressomd</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">box_l</span><span class="o">=</span><span class="p">[</span><span class="mf">10.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">,</span> <span class="mf">10.</span><span class="p">])</span>
<span class="n">system</span><span class="o">.</span><span class="n">time_step</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">system</span><span class="o">.</span><span class="n">cell_system</span><span class="o">.</span><span class="n">skin</span> <span class="o">=</span> <span class="mf">0.4</span>
<span class="n">system</span><span class="o">.</span><span class="n">periodicity</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span>
</pre></div>
</div>
<p>This code creates a system with a cubic unit cell of length 10 in simulation
units, and sets the skin to 0.4 simulation units and the time step to 0.01
simulation units.</p>
<p>Some variables belong to the <code class="docutils literal notranslate"><span class="pre">System</span></code> class and will be explained in the list
below, while other variables such as the skin belong to objects that are
attached to the class, and will be explain in subsequent sections and chapters.
Note that for many vectorial properties, e.g. <code class="docutils literal notranslate"><span class="pre">box_l</span></code> and <code class="docutils literal notranslate"><span class="pre">periodicity</span></code>,
component-wise manipulation
like <code class="docutils literal notranslate"><span class="pre">system.box_l[0]</span> <span class="pre">=</span> <span class="pre">1</span></code> or in-place operators like <code class="docutils literal notranslate"><span class="pre">+=</span></code> or <code class="docutils literal notranslate"><span class="pre">*=</span></code> are not
allowed and result in an error. This behavior is inherited, so the same applies
to <code class="docutils literal notranslate"><span class="pre">a</span></code> after <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">system.box_l</span></code>. If you want to use a vectorial property
for further calculations, you should explicitly make a copy e.g. via
<code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">=</span> <span class="pre">numpy.copy(system.box_l)</span></code>.</p>
<ul>
<li><p><a class="reference internal" href="espressomd.html#espressomd.system.System.box_l" title="espressomd.system.System.box_l"><code class="xref py py-attr docutils literal notranslate"><span class="pre">box_l</span></code></a></p>
<p>Simulation box lengths of the cuboid box used by <em>ESPResSo</em>.
Note that if you change the box length during the simulation, the folded
particle coordinates will remain the same, i.e., the particle stay in
the same image box, but at the same relative position in their image
box. If you want to scale the positions, use the command
<a class="reference internal" href="espressomd.html#espressomd.system.System.change_volume_and_rescale_particles" title="espressomd.system.System.change_volume_and_rescale_particles"><code class="xref py py-meth docutils literal notranslate"><span class="pre">change_volume_and_rescale_particles()</span></code></a>.</p>
</li>
<li><p><a class="reference internal" href="espressomd.html#espressomd.system.System.periodicity" title="espressomd.system.System.periodicity"><code class="xref py py-attr docutils literal notranslate"><span class="pre">periodicity</span></code></a></p>
<p>Specifies periodicity for the three directions. <em>ESPResSo</em> can be instructed
to treat some dimensions as non-periodic. By default <em>ESPResSo</em> assumes periodicity in
all directions which equals setting this variable to <code class="docutils literal notranslate"><span class="pre">[True,</span> <span class="pre">True,</span> <span class="pre">True]</span></code>.
A dimension is specified as non-periodic via setting the periodicity
variable for this dimension to <code class="docutils literal notranslate"><span class="pre">False</span></code>. E.g. Periodicity only in z-direction
is obtained by <code class="docutils literal notranslate"><span class="pre">[False,</span> <span class="pre">False,</span> <span class="pre">True]</span></code>. Caveat: Be aware of the fact that making a
dimension non-periodic does not hinder particles from leaving the box in
this direction; in this case, shape-based constraints can be used to keep
particles in the simulation box. For more details, see <a class="reference internal" href="#boundary-conditions"><span class="std std-ref">Boundary conditions</span></a>.</p>
</li>
<li><p><a class="reference internal" href="espressomd.html#espressomd.system.System.time_step" title="espressomd.system.System.time_step"><code class="xref py py-attr docutils literal notranslate"><span class="pre">time_step</span></code></a></p>
<p>Time step for MD integration.</p>
</li>
<li><p><a class="reference internal" href="espressomd.html#espressomd.system.System.time" title="espressomd.system.System.time"><code class="xref py py-attr docutils literal notranslate"><span class="pre">time</span></code></a></p>
<p>The simulation time.</p>
</li>
<li><p><a class="reference internal" href="espressomd.html#espressomd.system.System.min_global_cut" title="espressomd.system.System.min_global_cut"><code class="xref py py-attr docutils literal notranslate"><span class="pre">min_global_cut</span></code></a></p>
<p>Minimal total cutoff for real space. Effectively, this plus the
<a class="reference internal" href="espressomd.html#espressomd.cell_system.CellSystem.skin" title="espressomd.cell_system.CellSystem.skin"><code class="xref py py-attr docutils literal notranslate"><span class="pre">skin</span></code></a> is the minimally possible
cell size. <em>ESPResSo</em> typically determines this value automatically, but some
algorithms, virtual sites, require you to specify it manually.</p>
</li>
<li><p><a class="reference internal" href="espressomd.html#espressomd.system.System.max_cut_bonded" title="espressomd.system.System.max_cut_bonded"><code class="xref py py-attr docutils literal notranslate"><span class="pre">max_cut_bonded</span></code></a></p>
<p><em>read-only</em> Maximal cutoff of bonded interactions.</p>
</li>
<li><p><a class="reference internal" href="espressomd.html#espressomd.system.System.max_cut_nonbonded" title="espressomd.system.System.max_cut_nonbonded"><code class="xref py py-attr docutils literal notranslate"><span class="pre">max_cut_nonbonded</span></code></a></p>
<p><em>read-only</em> Maximal cutoff of non-bonded interactions.</p>
</li>
</ul>
<section id="accessing-module-states">
<span id="id3"></span><h3><span class="section-number">4.1.1. </span>Accessing module states<a class="headerlink" href="#accessing-module-states" title="Permalink to this headline">¶</a></h3>
<p>Some variables like or are no longer directly available as attributes.
In these cases they can be easily derived from the corresponding Python
objects like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">n_part</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">part</span><span class="p">)</span>
</pre></div>
</div>
<p>or by calling the corresponding <code class="docutils literal notranslate"><span class="pre">get_state()</span></code> methods like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">temperature</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">thermostat</span><span class="o">.</span><span class="n">get_state</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;kT&#39;</span><span class="p">]</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">thermostat</span><span class="o">.</span><span class="n">get_state</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;gamma&#39;</span><span class="p">]</span>
<span class="n">gamma_rot</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">thermostat</span><span class="o">.</span><span class="n">get_state</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;gamma_rotation&#39;</span><span class="p">]</span>
</pre></div>
</div>
</section>
</section>
<section id="simulation-box">
<span id="id4"></span><h2><span class="section-number">4.2. </span>Simulation box<a class="headerlink" href="#simulation-box" title="Permalink to this headline">¶</a></h2>
<section id="boundary-conditions">
<span id="id5"></span><h3><span class="section-number">4.2.1. </span>Boundary conditions<a class="headerlink" href="#boundary-conditions" title="Permalink to this headline">¶</a></h3>
<section id="periodic-boundaries">
<span id="id6"></span><h4><span class="section-number">4.2.1.1. </span>Periodic boundaries<a class="headerlink" href="#periodic-boundaries" title="Permalink to this headline">¶</a></h4>
<p>With periodic boundary conditions, particles interact with periodic
images of all particles in the system. This is the default behavior.
When particles cross a box boundary, their position are folded and
their image box counter are incremented.</p>
<p>From the Python interface, the folded position is accessed with
<a class="reference internal" href="espressomd.html#espressomd.particle_data.ParticleHandle.pos_folded" title="espressomd.particle_data.ParticleHandle.pos_folded"><code class="xref py py-attr docutils literal notranslate"><span class="pre">pos_folded</span></code></a> and the image
box counter with <a class="reference internal" href="espressomd.html#espressomd.particle_data.ParticleHandle.image_box" title="espressomd.particle_data.ParticleHandle.image_box"><code class="xref py py-attr docutils literal notranslate"><span class="pre">image_box</span></code></a>.
Note that <a class="reference internal" href="espressomd.html#espressomd.particle_data.ParticleHandle.pos" title="espressomd.particle_data.ParticleHandle.pos"><code class="xref py py-attr docutils literal notranslate"><span class="pre">pos</span></code></a> gives the
unfolded particle position.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">espressomd</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">espressomd</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">box_l</span><span class="o">=</span><span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">],</span> <span class="n">periodicity</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">])</span>
<span class="n">system</span><span class="o">.</span><span class="n">time_step</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">system</span><span class="o">.</span><span class="n">cell_system</span><span class="o">.</span><span class="n">skin</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">part</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="p">[</span><span class="mf">4.9</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">v</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
<span class="n">system</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;pos        = </span><span class="si">{p.pos}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;pos_folded = </span><span class="si">{p.pos_folded}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;image_box  = </span><span class="si">{p.image_box}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pos        = [5.1 0.  0. ]
pos_folded = [0.1 0.  0. ]
image_box  = [1 0 0]
</pre></div>
</div>
</section>
<section id="open-boundaries">
<span id="id7"></span><h4><span class="section-number">4.2.1.2. </span>Open boundaries<a class="headerlink" href="#open-boundaries" title="Permalink to this headline">¶</a></h4>
<p>With open boundaries, particles can leave the simulation box.
What happens in this case depends on which algorithm is used.
Some algorithms may require open boundaries,
such as <a class="reference internal" href="integration.html#stokesian-dynamics"><span class="std std-ref">Stokesian Dynamics</span></a>.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">espressomd</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">espressomd</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">box_l</span><span class="o">=</span><span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">],</span> <span class="n">periodicity</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">])</span>
<span class="n">system</span><span class="o">.</span><span class="n">time_step</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">system</span><span class="o">.</span><span class="n">cell_system</span><span class="o">.</span><span class="n">skin</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">part</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="p">[</span><span class="mf">4.9</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">v</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
<span class="n">system</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;pos        = </span><span class="si">{p.pos}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;pos_folded = </span><span class="si">{p.pos_folded}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;image_box  = </span><span class="si">{p.image_box}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pos        = [5.1 0.  0. ]
pos_folded = [5.1 0.  0. ]
image_box  = [0 0 0]
</pre></div>
</div>
</section>
<section id="lees-edwards-boundary-conditions">
<span id="id8"></span><h4><span class="section-number">4.2.1.3. </span>Lees–Edwards boundary conditions<a class="headerlink" href="#lees-edwards-boundary-conditions" title="Permalink to this headline">¶</a></h4>
<p>Lees–Edwards boundary conditions (LEbc) are special periodic boundary
conditions to simulate systems under shear stress <span id="id9">[<a class="reference internal" href="bibliography.html#id61" title="A. W. Lees and S. F. Edwards. The computer study of transport processes under extreme conditions. Journal of Physics C: Solid State Physics, 1972. doi:10.1088/0022-3719/5/15/006.">Lees and Edwards, 1972</a>]</span>.
Periodic images of particles across the shear boundary appear with a
time-dependent position offset. When a particle crosses the shear boundary,
it appears to the opposite side of the simulation box with a position offset
and a shear velocity <span id="id10">[<a class="reference internal" href="bibliography.html#id15" title="Sebastian Bindgen, Florian Weik, Rudolf Weeber, Erin Koos, and Pierre de Buyl. Lees-edwards boundary conditions for translation invariant shear flow: implementation and transport properties. Physics of Fluids, 33(8):083615, 2021. doi:10.1063/5.0055396.">Bindgen <em>et al.</em>, 2021</a>]</span>.</p>
<p>LEbc require a fully periodic system and are configured with
<a class="reference internal" href="espressomd.html#espressomd.lees_edwards.LinearShear" title="espressomd.lees_edwards.LinearShear"><code class="xref py py-class docutils literal notranslate"><span class="pre">LinearShear</span></code></a> and
<a class="reference internal" href="espressomd.html#espressomd.lees_edwards.OscillatoryShear" title="espressomd.lees_edwards.OscillatoryShear"><code class="xref py py-class docutils literal notranslate"><span class="pre">OscillatoryShear</span></code></a>.
To temporarily disable LEbc, use <a class="reference internal" href="espressomd.html#espressomd.lees_edwards.Off" title="espressomd.lees_edwards.Off"><code class="xref py py-class docutils literal notranslate"><span class="pre">Off</span></code></a>.
To completely disable LEbc and reinitialize the box geometry, do
<code class="docutils literal notranslate"><span class="pre">system.lees_edwards.protocol</span> <span class="pre">=</span> <span class="pre">None</span></code>.</p>
<p>Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">espressomd</span>
<span class="kn">import</span> <span class="nn">espressomd.lees_edwards</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">espressomd</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">box_l</span><span class="o">=</span><span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">])</span>
<span class="n">system</span><span class="o">.</span><span class="n">time_step</span> <span class="o">=</span> <span class="mf">0.1</span>
<span class="n">system</span><span class="o">.</span><span class="n">cell_system</span><span class="o">.</span><span class="n">skin</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">system</span><span class="o">.</span><span class="n">cell_system</span><span class="o">.</span><span class="n">set_n_square</span><span class="p">(</span><span class="n">use_verlet_lists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">le_protocol</span> <span class="o">=</span> <span class="n">espressomd</span><span class="o">.</span><span class="n">lees_edwards</span><span class="o">.</span><span class="n">LinearShear</span><span class="p">(</span>
    <span class="n">shear_velocity</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">initial_pos_offset</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">time_0</span><span class="o">=-</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">system</span><span class="o">.</span><span class="n">lees_edwards</span><span class="o">.</span><span class="n">set_boundary_conditions</span><span class="p">(</span>
    <span class="n">shear_direction</span><span class="o">=</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="c1"># shear along y-axis</span>
    <span class="n">shear_plane_normal</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="c1"># shift when crossing the x-boundary</span>
    <span class="n">protocol</span><span class="o">=</span><span class="n">le_protocol</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">part</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pos</span><span class="o">=</span><span class="p">[</span><span class="mf">4.9</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">v</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
<span class="n">system</span><span class="o">.</span><span class="n">integrator</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;pos        = </span><span class="si">{p.pos}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;pos_folded = </span><span class="si">{p.pos_folded}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;image_box  = </span><span class="si">{p.image_box}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;velocity   = </span><span class="si">{p.v}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Output:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>pos        = [5.1 0.2 0. ]
pos_folded = [0.1 0.2 0. ]
image_box  = [1 0 0]
velocity   = [0.1 0.1 0. ]
</pre></div>
</div>
<p>Particles inserted outside the box boundaries will be wrapped around
using the normal periodic boundary rules, i.e. they will not be sheared,
even though their <a class="reference internal" href="espressomd.html#espressomd.particle_data.ParticleHandle.image_box" title="espressomd.particle_data.ParticleHandle.image_box"><code class="xref py py-attr docutils literal notranslate"><span class="pre">image_box</span></code></a>
is <em>not</em> zero.</p>
<p>Once a valid tuple <code class="docutils literal notranslate"><span class="pre">(shear_direction,</span> <span class="pre">shear_plane_normal,</span> <span class="pre">protocol)</span></code> has been
set via <a class="reference internal" href="espressomd.html#espressomd.lees_edwards.LeesEdwards.set_boundary_conditions" title="espressomd.lees_edwards.LeesEdwards.set_boundary_conditions"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_boundary_conditions()</span></code></a>,
one can update the protocol via a simple assignment of the form
<code class="docutils literal notranslate"><span class="pre">system.lees_edwards.protocol</span> <span class="pre">=</span> <span class="pre">new_le_protocol</span></code>, in which case
the shear direction and shear normal are left unchanged. The method
<a class="reference internal" href="espressomd.html#espressomd.lees_edwards.LeesEdwards.set_boundary_conditions" title="espressomd.lees_edwards.LeesEdwards.set_boundary_conditions"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_boundary_conditions()</span></code></a>
is the only way to modify the shear direction and shear normal.</p>
</section>
</section>
<section id="cell-systems">
<span id="id11"></span><h3><span class="section-number">4.2.2. </span>Cell systems<a class="headerlink" href="#cell-systems" title="Permalink to this headline">¶</a></h3>
<p>This section deals with the flexible particle data organization of <em>ESPResSo</em>.
<em>ESPResSo</em> is able to change the organization of the particles in the computer
memory to accommodate for the needs of the algorithms being used.
For details on the internal organization,
refer to section <a class="reference internal" href="under_the_hood.html#internal-particle-organization"><span class="std std-ref">Internal particle organization</span></a>.</p>
<section id="global-properties">
<span id="id12"></span><h4><span class="section-number">4.2.2.1. </span>Global properties<a class="headerlink" href="#global-properties" title="Permalink to this headline">¶</a></h4>
<p>The properties of the cell system can be accessed via the system
<a class="reference internal" href="espressomd.html#espressomd.system.System.cell_system" title="espressomd.system.System.cell_system"><code class="xref py py-class docutils literal notranslate"><span class="pre">cell_system</span></code></a> attribute:</p>
<ul>
<li><p><a class="reference internal" href="espressomd.html#espressomd.cell_system.CellSystem.node_grid" title="espressomd.cell_system.CellSystem.node_grid"><code class="xref py py-attr docutils literal notranslate"><span class="pre">node_grid</span></code></a></p>
<p>3D node grid for real space domain decomposition (optional, if
unset an optimal partition is chosen automatically). The domain decomposition
can be visualized with <code class="file docutils literal notranslate"><span class="pre">samples/visualization_cellsystem.py</span></code>.</p>
</li>
<li><p><a class="reference internal" href="espressomd.html#espressomd.cell_system.CellSystem.skin" title="espressomd.cell_system.CellSystem.skin"><code class="xref py py-attr docutils literal notranslate"><span class="pre">skin</span></code></a></p>
<p>Skin for the Verlet list. This value has to be set, otherwise the simulation will not start.</p>
</li>
</ul>
<p>Details about the cell system can be obtained by
<a class="reference internal" href="espressomd.html#espressomd.cell_system.CellSystem.get_state" title="espressomd.cell_system.CellSystem.get_state"><code class="xref py py-meth docutils literal notranslate"><span class="pre">get_state()</span></code></a>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">cell_grid</span></code>       Dimension of the inner cell grid (only for regular decomposition).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">cell_size</span></code>       Box-length of a cell (only for regular decomposition).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">n_nodes</span></code>         Number of MPI nodes.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">node_grid</span></code>       MPI domain partition.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">type</span></code>            The current type of the cell system.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">skin</span></code>            Verlet list skin.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">verlet_reuse</span></code>    Average number of integration steps the Verlet list is re-used.</p></li>
</ul>
</section>
<section id="regular-decomposition">
<span id="id13"></span><h4><span class="section-number">4.2.2.2. </span>Regular decomposition<a class="headerlink" href="#regular-decomposition" title="Permalink to this headline">¶</a></h4>
<p>Invoking <a class="reference internal" href="espressomd.html#espressomd.cell_system.CellSystem.set_regular_decomposition" title="espressomd.cell_system.CellSystem.set_regular_decomposition"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_regular_decomposition()</span></code></a>
selects the regular decomposition cell scheme, using Verlet lists for the
calculation of the interactions. If you specify <code class="docutils literal notranslate"><span class="pre">use_verlet_lists=False</span></code>,
only the regular decomposition is used, but not the Verlet lists.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">espressomd</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">espressomd</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">box_l</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">system</span><span class="o">.</span><span class="n">cell_system</span><span class="o">.</span><span class="n">set_regular_decomposition</span><span class="p">(</span><span class="n">use_verlet_lists</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>The regular decomposition cellsystem is the default system and suits most
applications with short ranged interactions. The particles are divided
up spatially into small compartments, the cells, such that the cell size
is larger than the maximal interaction range. In this case interactions
only occur between particles in adjacent cells. Since the interaction
range should be much smaller than the total system size, leaving out all
interactions between non-adjacent cells can mean a tremendous speed-up.
Moreover, since for constant interaction range, the number of particles
in a cell depends only on the density. The number of interactions is
therefore of the order <span class="math notranslate nohighlight">\(N\)</span> instead of order <span class="math notranslate nohighlight">\(N^2\)</span> if one has to
calculate all pair interactions.</p>
<p>With this scheme, there must be at least two cells per direction,
and at most 32 cells per direction for a cubic box geometry.
The number of cells per direction depends on the interaction range cutoff
<span class="math notranslate nohighlight">\(l_{\mathrm{cut}}\)</span>, the Verlet list skin <span class="math notranslate nohighlight">\(l_{\mathrm{skin}}\)</span>
and the box length <span class="math notranslate nohighlight">\(l_{\mathrm{box}}\)</span>, and is determined automatically
by solving several equations. It can be useful to know how to estimate the
number of cells per direction, because it limits the number of MPI ranks
that can be allocated to an MPI-parallel simulation. As a rule of thumb,
for a cubic box geometry the number of cells per direction is often:</p>
<div class="math notranslate nohighlight">
\[\left\lfloor \frac{l_{\mathrm{box}}}{l_{\mathrm{cut}} + l_{\mathrm{skin}}} \right\rfloor\]</div>
<p>For example, in a system with box length 12, LJ cutoff 2.5 and Verlet
skin 0.4, the number of cells cannot be more than 4 in each direction.
A runtime error will be triggered during integration when running a
simulation with such a system and allocating more than 64 MPI ranks
in total, or more than 4 MPI ranks per direction. In this situation,
consider increasing the box size or decreasing the interaction cutoff
or Verlet list skin.</p>
</section>
<section id="n-squared">
<span id="id14"></span><h4><span class="section-number">4.2.2.3. </span>N-squared<a class="headerlink" href="#n-squared" title="Permalink to this headline">¶</a></h4>
<p>Invoking <a class="reference internal" href="espressomd.html#espressomd.cell_system.CellSystem.set_n_square" title="espressomd.cell_system.CellSystem.set_n_square"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_n_square()</span></code></a>
selects the very primitive N-squared cellsystem, which calculates
the interactions for all particle pairs. Therefore it loops over all
particles, giving an unfavorable computation time scaling of
<span class="math notranslate nohighlight">\(N^2\)</span>. However, algorithms like MMM1D or the plain Coulomb
interaction in the cell model require the calculation of all pair
interactions.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">espressomd</span>
<span class="n">system</span> <span class="o">=</span> <span class="n">espressomd</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">box_l</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">system</span><span class="o">.</span><span class="n">cell_system</span><span class="o">.</span><span class="n">set_n_square</span><span class="p">()</span>
</pre></div>
</div>
<p>In a multiple processor environment, the N-squared cellsystem uses a
simple particle balancing scheme to have a nearly equal number of
particles per CPU, <span class="math notranslate nohighlight">\(n\)</span> nodes have <span class="math notranslate nohighlight">\(m\)</span> particles, and
<span class="math notranslate nohighlight">\(p-n\)</span> nodes have <span class="math notranslate nohighlight">\(m+1\)</span> particles, such that
<span class="math notranslate nohighlight">\(n \cdot m + (p - n) \cdot (m + 1) = N\)</span>, the total number of particles. Therefore the
computational load should be balanced fairly equal among the nodes, with
one exception: This code always uses one CPU for the interaction between
two different nodes. For an odd number of nodes, this is fine, because
the total number of interactions to calculate is a multiple of the
number of nodes, but for an even number of nodes, for each of the
<span class="math notranslate nohighlight">\(p-1\)</span> communication rounds, one processor is idle.</p>
<p>E.g. for 2 processors, there are 3 interactions: 0-0, 1-1, 0-1.
Naturally, 0-0 and 1-1 are treated by processor 0 and 1, respectively.
But the 0-1 interaction is treated by node 1 alone, so the workload for
this node is twice as high. For 3 processors, the interactions are 0-0,
1-1, 2-2, 0-1, 1-2, 0-2. Of these interactions, node 0 treats 0-0 and
0-2, node 1 treats 1-1 and 0-1, and node 2 treats 2-2 and 1-2.</p>
<p>Therefore it is highly recommended that you use N-squared only with an
odd number of nodes, if with multiple processors at all.</p>
</section>
<section id="hybrid-decomposition">
<span id="id15"></span><h4><span class="section-number">4.2.2.4. </span>Hybrid decomposition<a class="headerlink" href="#hybrid-decomposition" title="Permalink to this headline">¶</a></h4>
<p>If for a simulation setup the interaction range is much smaller than the
system size, use of a <a class="reference internal" href="#regular-decomposition"><span class="std std-ref">Regular decomposition</span></a> leads to efficient
scaling behavior (order <span class="math notranslate nohighlight">\(N\)</span> instead of order <span class="math notranslate nohighlight">\(N^2\)</span>).
Consider a system with many small particles, e.g. a polymer solution.
There, already the addition of one single large particle increases the maximum
interaction range and thus the minimum cell size of the decomposition.
Due to this larger cell size, throughout the simulation box a large number
of non-interacting pairs of small particles is visited during the short
range calculation. This can considerably increase the computational cost of
the simulation.</p>
<p>For such simulation setups, i.e. systems with a few large particles and much
more small particles, the hybrid decomposition can be used. This hybrid
decomposition is backed by two coupled particle decompositions which can
be used to efficiently deal with the differently sized particles.
Specifically that means putting the small particles into a
<a class="reference internal" href="#regular-decomposition"><span class="std std-ref">Regular decomposition</span></a>. There, the minimum cell size is limited only
by the maximum interaction range of all particles within this decomposition.
The few large particles are put into a <a class="reference internal" href="#n-squared"><span class="std std-ref">N-squared</span></a> cellsystem. Particles
within this decomposition interact both, amongst each other and with all small
particles in the <a class="reference internal" href="#regular-decomposition"><span class="std std-ref">Regular decomposition</span></a>. The hybrid decomposition can therefore
effectively recover the computational efficiency of the regular decomposition,
given that only a few large particles have been added.</p>
<p>Invoking <a class="reference internal" href="espressomd.html#espressomd.cell_system.CellSystem.set_hybrid_decomposition" title="espressomd.cell_system.CellSystem.set_hybrid_decomposition"><code class="xref py py-meth docutils literal notranslate"><span class="pre">set_hybrid_decomposition()</span></code></a>
selects the hybrid decomposition.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">system</span> <span class="o">=</span> <span class="n">espressomd</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">box_l</span><span class="o">=</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">system</span><span class="o">.</span><span class="n">cell_system</span><span class="o">.</span><span class="n">set_hybrid_decomposition</span><span class="p">(</span><span class="n">n_square_types</span><span class="o">=</span><span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">},</span> <span class="n">cutoff_regular</span><span class="o">=</span><span class="mf">1.2</span><span class="p">)</span>
</pre></div>
</div>
<p>Here, <code class="docutils literal notranslate"><span class="pre">n_square_types</span></code> is a python set containing the types of particles to
put into the <a class="reference internal" href="#n-squared"><span class="std std-ref">N-squared</span></a> cellsystem, i.e. the particle types of the
large particles. Particles with other types will by default be put into the
<a class="reference internal" href="#regular-decomposition"><span class="std std-ref">Regular decomposition</span></a>. Note that for now it is also necessary to manually set
the maximum cutoff to consider for interactions within the
<a class="reference internal" href="#regular-decomposition"><span class="std std-ref">Regular decomposition</span></a>, i.e. the maximum interaction range among all
small particle types. Set this via the <code class="docutils literal notranslate"><span class="pre">cutoff_regular</span></code> parameter.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The hybrid particle decomposition has been added to <em>ESPResSo</em> only recently and
for now should be considered an experimental feature. If you notice some unexpected
behavior please let us know via github or the mailing list.</p>
</div>
</section>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">4. Setting up the system</a><ul>
<li><a class="reference internal" href="#setting-global-variables">4.1. Setting global variables</a><ul>
<li><a class="reference internal" href="#accessing-module-states">4.1.1. Accessing module states</a></li>
</ul>
</li>
<li><a class="reference internal" href="#simulation-box">4.2. Simulation box</a><ul>
<li><a class="reference internal" href="#boundary-conditions">4.2.1. Boundary conditions</a></li>
<li><a class="reference internal" href="#cell-systems">4.2.2. Cell systems</a></li>
</ul>
</li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018-2023, The ESPResSo project.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>