
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>3. Running a simulation &#8212; ESPResSo 4.2.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="_static/blockquotes.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/toggleprompt.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="4. Setting up the system" href="system_setup.html" />
    <link rel="prev" title="2. Installation" href="installation.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="running-a-simulation">
<span id="id1"></span><h1><span class="section-number">3. </span>Running a simulation<a class="headerlink" href="#running-a-simulation" title="Permalink to this headline">¶</a></h1>
<p><em>ESPResSo</em> is implemented as a Python module. This means that you need to write a
python script for any task you want to perform with <em>ESPResSo</em>. In this chapter,
the basic structure of the interface will be explained. For a practical
introduction, see the tutorials, which are also part of the
distribution.</p>
<section id="running-es">
<span id="id2"></span><h2><span class="section-number">3.1. </span>Running <em>ESPResSo</em><a class="headerlink" href="#running-es" title="Permalink to this headline">¶</a></h2>
<section id="running-a-script">
<h3><span class="section-number">3.1.1. </span>Running a script<a class="headerlink" href="#running-a-script" title="Permalink to this headline">¶</a></h3>
<p>To use <em>ESPResSo</em>, you need to import the <code class="docutils literal notranslate"><span class="pre">espressomd</span></code> module in your
Python script. To this end, the folder containing the python module
needs to be in the Python search path. The module is located in the
<code class="file docutils literal notranslate"><span class="pre">src/python</span></code> folder under the build directory.</p>
<p>A convenient way to run Python with the correct path is to use the
<code class="docutils literal notranslate"><span class="pre">pypresso</span></code> script located in the build directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./pypresso simulation.py
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">pypresso</span></code> script is just a wrapper in order to expose the <em>ESPResSo</em> python
module to the system’s Python interpreter by modifying the <code class="docutils literal notranslate"><span class="pre">$PYTHONPATH</span></code>.
If you have installed <em>ESPResSo</em> from a Linux package manager that doesn’t provide
the <code class="docutils literal notranslate"><span class="pre">pypresso</span></code> script, you will need to modify the <code class="docutils literal notranslate"><span class="pre">$PYTHONPATH</span></code> and
possibly the <code class="docutils literal notranslate"><span class="pre">$LD_LIBRARY_PATH</span></code> too, depending on which symbols are missing.</p>
<p>The next chapter, <a class="reference internal" href="system_setup.html#setting-up-the-system"><span class="std std-ref">Setting up the system</span></a>, will explain in more details
how to write a simulation script for <em>ESPResSo</em>. If you don’t have any script,
simply call one of the files listed in section <a class="reference internal" href="introduction.html#sample-scripts"><span class="std std-ref">Sample scripts</span></a>.</p>
</section>
<section id="using-the-console">
<h3><span class="section-number">3.1.2. </span>Using the console<a class="headerlink" href="#using-the-console" title="Permalink to this headline">¶</a></h3>
<p>Since <em>ESPResSo</em> can be manipulated like any other Python module, it is possible
to interact with it in a Python interpreter. Simply run the <code class="docutils literal notranslate"><span class="pre">pypresso</span></code>
script without arguments to start a Python session:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./pypresso
</pre></div>
</div>
<p>Likewise, a Jupyter console can be started with the <code class="docutils literal notranslate"><span class="pre">ipypresso</span></code> script,
which is also located in the build directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./ipypresso console
</pre></div>
</div>
<p>The name comes from the IPython interpreter, today known as Jupyter.</p>
</section>
<section id="interactive-notebooks">
<h3><span class="section-number">3.1.3. </span>Interactive notebooks<a class="headerlink" href="#interactive-notebooks" title="Permalink to this headline">¶</a></h3>
<p>Tutorials are available as notebooks, i.e. they consist of a <code class="docutils literal notranslate"><span class="pre">.ipynb</span></code>
file which contains both the source code and the corresponding explanations.
They can be viewed, changed and run interactively. To generate the tutorials
in the build folder, do:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>make tutorials
</pre></div>
</div>
<p>The tutorials contain solutions hidden with the <code class="docutils literal notranslate"><span class="pre">exercise2</span></code> NB extension.
Since this extension is only available for Jupyter Notebook, JupyterLab
users need to convert the tutorials:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> f in doc/tutorials/*/*.ipynb<span class="p">;</span> <span class="k">do</span>
  ./pypresso doc/tutorials/convert.py exercise2 --to-jupyterlab <span class="si">${</span><span class="nv">f</span><span class="si">}</span>
<span class="k">done</span>
</pre></div>
</div>
<p>Likewise, VS Code Jupyter users need to convert the tutorials:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> f in doc/tutorials/*/*.ipynb<span class="p">;</span> <span class="k">do</span>
  ./pypresso doc/tutorials/convert.py exercise2 --to-vscode-jupyter <span class="si">${</span><span class="nv">f</span><span class="si">}</span>
<span class="k">done</span>
</pre></div>
</div>
<p>To interact with notebooks, move to the directory containing the tutorials
and call the <code class="docutils literal notranslate"><span class="pre">ipypresso</span></code> script to start a local Jupyter session.</p>
<p>For Jupyter Notebook and IPython users:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> doc/tutorials
../../ipypresso notebook
</pre></div>
</div>
<p>For JupyterLab users:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> doc/tutorials
../../ipypresso lab
</pre></div>
</div>
<p>For VS Code Jupyter users, no action is needed if <code class="docutils literal notranslate"><span class="pre">pypresso</span></code> was set as
the interpreter path (see details in <a class="reference internal" href="#running-inside-an-ide"><span class="std std-ref">Running inside an IDE</span></a>).</p>
<p>You may then browse through the different tutorial folders. Files whose name
ends with extension <code class="docutils literal notranslate"><span class="pre">.ipynb</span></code> can be opened in the browser. Click on the Run
button to execute the current block, or use the keyboard shortcut Shift+Enter.
If the current block is a code block, the <code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[</span> <span class="pre">]</span></code> label to the left will
change to <code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[*]</span></code> while the code is being executed, and become <code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[1]</span></code>
once the execution has completed. The number increments itself every time a
code cell is executed. This bookkeeping is extremely useful when modifying
previous code cells, as it shows which cells are out-of-date. It’s also
possible to run all cells by clicking on the “Run” drop-down menu, then on
“Run All Below”. This will change all labels to <code class="docutils literal notranslate"><span class="pre">In</span> <span class="pre">[*]</span></code> to show that the
first one is running, while the subsequent ones are awaiting execution.</p>
<p>You’ll also see that many cells generate an output. When the output becomes
very long, Jupyter will automatically put it in a box with a vertical scrollbar.
The output may also contain static plots, dynamic plots and videos. It is also
possible to start a 3D visualizer in a new window, however closing the window
will exit the Python interpreter and Jupyter will notify you that the current
Python kernel stopped. If a cell takes too long to execute, you may interrupt
it with the stop button.</p>
<p>Solutions cells are created using the <code class="docutils literal notranslate"><span class="pre">exercise2</span></code> plugin from nbextensions.
To prevent solution code cells from running when clicking on “Run All”, these
code cells need to be converted to Markdown cells and fenced with <code class="docutils literal notranslate"><span class="pre">```python</span></code>
and <code class="docutils literal notranslate"><span class="pre">```</span></code>.</p>
<p>To close the Jupyter session, go to the terminal where it was started and use
the keyboard shortcut Ctrl+C twice.</p>
<p>When starting a Jupyter session, you may see the following warning in the
terminal:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>[TerminalIPythonApp] WARNING | Subcommand `ipython notebook` is deprecated and will be removed in future versions.
[TerminalIPythonApp] WARNING | You likely want to use `jupyter notebook` in the future
</pre></div>
</div>
<p>This only means <em>ESPResSo</em> was compiled with IPython instead of Jupyter. If Jupyter
is installed on your system, the notebook will automatically close IPython and
start Jupyter. To recompile <em>ESPResSo</em> with Jupyter, provide <code class="docutils literal notranslate"><span class="pre">cmake</span></code> with the flag
<code class="docutils literal notranslate"><span class="pre">-DIPYTHON_EXECUTABLE=$(which</span> <span class="pre">jupyter)</span></code>.</p>
<p>You can find the official Jupyter documentation at
<a class="reference external" href="https://jupyter.readthedocs.io/en/latest/running.html">https://jupyter.readthedocs.io/en/latest/running.html</a></p>
</section>
<section id="running-inside-an-ide">
<span id="id3"></span><h3><span class="section-number">3.1.4. </span>Running inside an IDE<a class="headerlink" href="#running-inside-an-ide" title="Permalink to this headline">¶</a></h3>
<p>You can use an integrated development environment (IDE) to develop and run <em>ESPResSo</em>
scripts. Suitable IDEs are e.g. <em>Visual Studio Code</em> and <em>Spyder</em>. They can
provide a workflow superior to that of a standard text editor as they offer
useful features such as advanced code completion, debugging and analysis tools
etc. The following example shows how to setup <em>ESPResSo</em> in <em>Visual Studio Code</em> on
Linux (tested with version 1.46.1). The process should be similar for every
Python IDE, namely the Python interpreter needs to be replaced.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">pypresso</span></code> executable can be set as a custom Python interpreter inside VS
Code. <em>ESPResSo</em> scripts can then be executed just like any other python script.
Inside VS Code, the Python extension needs to be installed. Next, click the
gear at the bottom left and choose <em>Settings</em>. Search for
<code class="docutils literal notranslate"><span class="pre">Default</span> <span class="pre">Interpreter</span> <span class="pre">Path</span></code> and change the setting to the path to your
<code class="docutils literal notranslate"><span class="pre">pypresso</span></code> executable, e.g.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>~/espresso/build/pypresso
</pre></div>
</div>
<p>After that, you can open scripts and execute them with the keyboard shortcut
Ctrl+F5.</p>
<p>Fig. <a class="reference internal" href="#vs-code-figure"><span class="std std-ref">Visual Studio Code interface</span></a> shows the VS Code interface with the interpreter
path set to <code class="docutils literal notranslate"><span class="pre">pypresso</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You may need to set the path relative to your home directory, i.e. <code class="docutils literal notranslate"><span class="pre">~/path/to/pypresso</span></code>.</p>
</div>
<figure class="align-center" id="id15">
<span id="vs-code-figure"></span><a class="reference internal image-reference" href="_images/vs-code-settings.png"><img alt="Visual Studio Code interface with the default interpreter path set to the ``pypresso`` executable" src="_images/vs-code-settings.png" style="width: 55.0%;" /></a>
<figcaption>
<p><span class="caption-text">Visual Studio Code interface</span><a class="headerlink" href="#id15" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
</section>
<section id="debugging-es">
<span id="id4"></span><h2><span class="section-number">3.2. </span>Debugging <em>ESPResSo</em><a class="headerlink" href="#debugging-es" title="Permalink to this headline">¶</a></h2>
<p>Exceptional situations occur in every program.  If <em>ESPResSo</em> crashes with a
segmentation fault, that means that there was a memory fault in the
simulation core which requires running the program in a debugger.  The
<code class="docutils literal notranslate"><span class="pre">pypresso</span></code> executable file is actually not a program but a script
which sets the Python path appropriately and starts the Python
interpreter with your arguments.  Thus it is not possible to directly
run <code class="docutils literal notranslate"><span class="pre">pypresso</span></code> in a debugger.  However, we provide some useful
command line options for the most common tools.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>./pypresso --tool &lt;args&gt;
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">--tool</span></code> can be any tool from the <a class="reference internal" href="#debugging-es-with-tools"><span class="std std-ref">table below</span></a>.
Only one tool can be used at a time. Some tools benefit from specific build
options, as outlined in the installation section <a class="reference internal" href="installation.html#troubleshooting"><span class="std std-ref">Troubleshooting</span></a>.
<em>ESPResSo</em> can be debugged in MPI environments, as outlined in section
<a class="reference internal" href="#debugging-parallel-code"><span class="std std-ref">Debugging parallel code</span></a>.</p>
<span id="debugging-es-with-tools"></span><table class="docutils align-default" id="id16">
<caption><span class="caption-text">Tools for the Python wrapper to <em>ESPResSo</em>.</span><a class="headerlink" href="#id16" title="Permalink to this table">¶</a></caption>
<colgroup>
<col style="width: 31%" />
<col style="width: 69%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Tool</p></th>
<th class="head"><p>Effect</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--gdb</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">gdb</span> <span class="pre">--args</span> <span class="pre">python</span> <span class="pre">&lt;args&gt;</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--lldb</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">lldb</span> <span class="pre">--</span> <span class="pre">python</span> <span class="pre">&lt;args&gt;</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--valgrind</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">valgrind</span> <span class="pre">--leak-check=full</span> <span class="pre">python</span> <span class="pre">&lt;args&gt;</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">--cuda-gdb</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">cuda-gdb</span> <span class="pre">--args</span> <span class="pre">python</span> <span class="pre">&lt;args&gt;</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">--cuda-memcheck</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">cuda-memcheck</span> <span class="pre">python</span> <span class="pre">&lt;args&gt;</span></code></p></td>
</tr>
</tbody>
</table>
</section>
<section id="parallel-computing">
<span id="id5"></span><h2><span class="section-number">3.3. </span>Parallel computing<a class="headerlink" href="#parallel-computing" title="Permalink to this headline">¶</a></h2>
<p>Many algorithms in <em>ESPResSo</em> are designed to work with multiple MPI ranks.
However, not all algorithms benefit from MPI parallelization equally.
Several algorithms only use MPI rank 0 (e.g. <a class="reference internal" href="reaction_methods.html#reaction-methods"><span class="std std-ref">Reaction methods</span></a>).
<em>ESPResSo</em> should work with most MPI implementations on the market;
see the <a class="reference internal" href="installation.html#term-MPI"><span class="xref std std-term">MPI installation requirements</span></a> for details.</p>
<section id="general-syntax">
<span id="id6"></span><h3><span class="section-number">3.3.1. </span>General syntax<a class="headerlink" href="#general-syntax" title="Permalink to this headline">¶</a></h3>
<p>To run a simulation on several MPI ranks, for example 4, simply invoke
the <code class="docutils literal notranslate"><span class="pre">pypresso</span></code> script with the following syntax:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mpiexec -n <span class="m">4</span> ./pypresso simulation.py
</pre></div>
</div>
<p>The cell system is automatically split among the MPI ranks, and data
is automatically gathered on the main rank, which means a regular <em>ESPResSo</em>
script can be executed in an MPI environment out-of-the-box. The number
of MPI ranks can be accessed via the system <code class="docutils literal notranslate"><span class="pre">n_nodes</span></code> state property.
The simulation box partition is controlled by the cell system
<a class="reference internal" href="espressomd.html#espressomd.cell_system.CellSystem.node_grid" title="espressomd.cell_system.CellSystem.node_grid"><code class="xref py py-attr docutils literal notranslate"><span class="pre">node_grid</span></code></a> property.
By default, MPI ranks are assigned in decreasing order, e.g. on 6 MPI ranks
<code class="docutils literal notranslate"><span class="pre">node_grid</span></code> is <code class="docutils literal notranslate"><span class="pre">[3,</span> <span class="pre">2,</span> <span class="pre">1]</span></code>. It is possible to re-assign the ranks by
changing the value of the <code class="docutils literal notranslate"><span class="pre">node_grid</span></code> property, however a few algorithms
(such as FFT-based electrostatic methods) only work for the default
partitioning scheme where values must be arranged in decreasing order.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># get the number of ranks</span>
<span class="nb">print</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">cell_system</span><span class="o">.</span><span class="n">get_state</span><span class="p">()[</span><span class="s2">&quot;n_nodes&quot;</span><span class="p">])</span>
<span class="c1"># re-assign the ranks</span>
<span class="n">system</span><span class="o">.</span><span class="n">cell_system</span><span class="o">.</span><span class="n">node_grid</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
<span class="n">system</span><span class="o">.</span><span class="n">cell_system</span><span class="o">.</span><span class="n">node_grid</span> <span class="o">=</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>There are alternative ways to invoke MPI on <code class="docutils literal notranslate"><span class="pre">pypresso</span></code>, but they share
similar options. The number after the <code class="docutils literal notranslate"><span class="pre">-n</span></code> option is the number of ranks,
which needs to be inferior or equal to the number of <em>physical</em> cores on the
workstation. Command <code class="docutils literal notranslate"><span class="pre">nproc</span></code> displays the number of <em>logical</em> cores on the
workstation. For architectures that support hyperthreading, the number of
logical cores is an integer multiple of the number of physical cores,
usually 2. Therefore on a hyperthreaded workstation with 32 cores,
at most 16 cores can be used without major performance loss, unless
extra arguments are passed to the <code class="docutils literal notranslate"><span class="pre">mpiexec</span></code> program.</p>
<p>On cluster computers, it might be necessary to load the MPI library with
<code class="docutils literal notranslate"><span class="pre">module</span> <span class="pre">load</span> <span class="pre">openmpi</span></code> or similar.</p>
</section>
<section id="performance-gain">
<span id="id7"></span><h3><span class="section-number">3.3.2. </span>Performance gain<a class="headerlink" href="#performance-gain" title="Permalink to this headline">¶</a></h3>
<p>Simulations executed in parallel with run faster, however the runtime
won’t decrease linearly with the number of MPI ranks. MPI-parallel
simulations introduce several sources of overhead and latency:</p>
<ul class="simple">
<li><p>overhead of serializing, communicating and deserializing data structures</p></li>
<li><p>extra calculations in the LB halo</p></li>
<li><p>extra calculations in the ghost shell
(see section <a class="reference internal" href="under_the_hood.html#internal-particle-organization"><span class="std std-ref">Internal particle organization</span></a> for more details)</p></li>
<li><p>latency due to blocking communication (i.e. a node remains idle
while waiting for a message from another node)</p></li>
<li><p>latency due to blocking data collection for GPU
(only relevant for GPU methods)</p></li>
<li><p>latency due to context switching</p></li>
<li><p>latency due to memory bandwidth</p></li>
</ul>
<p>While good performance can be achieved up to 32 MPI ranks, allocating more
than 32 ranks to a simulation will not always lead to significantly improved
run times. The performance gain is highly sensitive to the algorithms used
by the simulation, for example GPU methods rarely benefit from more than
8 MPI ranks. Performance is also affected by the number of features enabled
at compile time, even when these features are not used by the simulation;
do not hesitate to remove all features not required by the
simulation script and rebuild <em>ESPResSo</em> for optimal performance.</p>
<p>Benchmarking is often the best way to determine the optimal number of MPI
ranks for a given simulation setup. Please refer to the wiki chapter on
<a class="reference external" href="https://github.com/espressomd/espresso/wiki/Development#Benchmarking">benchmarking</a>
for more details.</p>
<p>Runtime speed-up is not the only appeal of MPI parallelization. Another
benefit is the possibility to distribute a calculation over multiple
compute nodes in clusters and high-performance environments, and therefore
split the data structures over multiple machines. This becomes necessary
when running simulations with millions of particles, as the memory
available on a single compute node would otherwise saturate.</p>
</section>
<section id="communication-model">
<span id="id8"></span><h3><span class="section-number">3.3.3. </span>Communication model<a class="headerlink" href="#communication-model" title="Permalink to this headline">¶</a></h3>
<p><em>ESPResSo</em> was originally designed for the “flat” model of communication:
each MPI rank binds to a logical CPU core. This communication model
doesn’t fully leverage shared memory on recent CPUs, such as <a class="reference external" href="https://en.wikipedia.org/wiki/Non-uniform_memory_access">NUMA
architectures</a>,
and <em>ESPResSo</em> currently doesn’t support the hybrid
MPI+<a class="reference external" href="https://www.openmp.org">OpenMP</a> programming model.</p>
<p>The MPI+CUDA programming model is supported, although only one GPU can be
used for the entire simulation. As a result, a blocking <em>gather</em> operation
is carried out to collect data from all ranks to the main rank, and a
blocking <em>scatter</em> operation is carried out to transfer the result of the
GPU calculation from the main rank back to all ranks. This latency limits
GPU-acceleration to simulations running on fewer than 8 MPI ranks.
For more details, see section <a class="reference internal" href="#gpu-acceleration"><span class="std std-ref">GPU acceleration</span></a>.</p>
<section id="the-mpi-callbacks-framework">
<span id="id9"></span><h4><span class="section-number">3.3.3.1. </span>The MPI callbacks framework<a class="headerlink" href="#the-mpi-callbacks-framework" title="Permalink to this headline">¶</a></h4>
<p>When starting a simulation with <span class="math notranslate nohighlight">\(n\)</span> MPI ranks, <em>ESPResSo</em> will internally
use MPI rank <span class="math notranslate nohighlight">\(0\)</span> as the head node (also referred to as the “main rank”)
and MPI ranks <span class="math notranslate nohighlight">\(1\)</span> to <span class="math notranslate nohighlight">\(n-1\)</span> as worker nodes. The Python interface
interacts only with the head node, and the head node forwards the information
to the worker nodes.</p>
<p>To put it another way, all worker nodes are idle until the user calls
a function that is designed to run in parallel,
in which case the head node calls the corresponding core function
and sends a request on the worker nodes to call the same core function.
The request can be a simple collective call, or a collective call with a
reduction if the function returns a value. The reduction can either:</p>
<ul class="simple">
<li><p>combine the <span class="math notranslate nohighlight">\(n\)</span> results via a mathematical operation
(usually a summation or a multiplication)</p></li>
<li><p>discard the result of the <span class="math notranslate nohighlight">\(n-1\)</span> worker nodes; this is done when
all ranks return the same value, or when the calculation can only be
carried out on the main rank but requires data from the other ranks</p></li>
<li><p>return the result of one rank when the calculation can only be carried out
by a specific rank; this is achieved by returning an <em>optional</em>, which
contains a value on the rank that has access to the information necessary
to carry out the calculation, while the other <span class="math notranslate nohighlight">\(n-1\)</span> ranks return
an empty optional</p></li>
</ul>
<p>For more details on this framework, please refer to the Doxygen documentation
of the the C++ core file <code class="file docutils literal notranslate"><span class="pre">MpiCallbacks.hpp</span></code>.</p>
</section>
</section>
<section id="debugging-parallel-code">
<span id="id10"></span><h3><span class="section-number">3.3.4. </span>Debugging parallel code<a class="headerlink" href="#debugging-parallel-code" title="Permalink to this headline">¶</a></h3>
<p>It is possible to debug an MPI-parallel simulation script with GDB.
Keep in mind that contrary to a textbook example MPI application, where
all ranks execute the <code class="docutils literal notranslate"><span class="pre">main</span></code> function, in <em>ESPResSo</em> the worker nodes are idle
until the head node on MPI rank 0 delegates work to them. This means that
on MPI rank &gt; 1, break points will only have an effect in code that can be
reached from a callback function whose pointer has been registered in the
<a class="reference internal" href="#the-mpi-callbacks-framework"><span class="std std-ref">MPI callbacks framework</span></a>.</p>
<p>The following command runs a script with 2 MPI ranks and binds a terminal
to each rank:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mpiexec -np <span class="m">2</span> xterm -fa <span class="s1">&#39;Monospace&#39;</span> -fs <span class="m">12</span> -e ./pypresso --gdb simulation.py
</pre></div>
</div>
<p>It can also be done via ssh with X-window forwarding:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh -X username@hostname
mpiexec -n <span class="m">2</span> -x <span class="nv">DISPLAY</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">${</span><span class="nv">DISPLAY</span><span class="si">}</span><span class="s2">&quot;</span> xterm -fa <span class="s1">&#39;Monospace&#39;</span> -fs <span class="m">12</span> <span class="se">\</span>
    -e ./pypresso --gdb simulation.py
</pre></div>
</div>
<p>The same syntax is used for C++ unit tests:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mpiexec -np <span class="m">2</span> xterm -fa <span class="s1">&#39;Monospace&#39;</span> -fs <span class="m">12</span> <span class="se">\</span>
    -e gdb src/core/unit_tests/EspressoSystemStandAlone_test
</pre></div>
</div>
</section>
</section>
<section id="gpu-acceleration">
<span id="id11"></span><h2><span class="section-number">3.4. </span>GPU acceleration<a class="headerlink" href="#gpu-acceleration" title="Permalink to this headline">¶</a></h2>
<section id="cuda-acceleration">
<span id="id12"></span><h3><span class="section-number">3.4.1. </span>CUDA acceleration<a class="headerlink" href="#cuda-acceleration" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Feature <code class="docutils literal notranslate"><span class="pre">CUDA</span></code> required</p>
</div>
<p><em>ESPResSo</em> is capable of delegating work to the GPU to speed up simulations.
Not every simulation method profits from GPU acceleration.
Refer to <a class="reference internal" href="introduction.html#available-simulation-methods"><span class="std std-ref">Available simulation methods</span></a>
to check whether your desired method can be used on the GPU.
In order to use GPU acceleration you need a NVIDIA GPU
and it needs to have at least compute capability 2.0.
For more details, please refer to the installation section
<a class="reference internal" href="installation.html#nvidia-gpu-acceleration"><span class="std std-ref">Nvidia GPU acceleration</span></a>.</p>
<p>For more information please check <a class="reference internal" href="espressomd.html#espressomd.cuda_init.CudaInitHandle" title="espressomd.cuda_init.CudaInitHandle"><code class="xref py py-class docutils literal notranslate"><span class="pre">espressomd.cuda_init.CudaInitHandle</span></code></a>.</p>
<section id="list-available-devices">
<span id="id13"></span><h4><span class="section-number">3.4.1.1. </span>List available devices<a class="headerlink" href="#list-available-devices" title="Permalink to this headline">¶</a></h4>
<p>To list available CUDA devices, call
<a class="reference internal" href="espressomd.html#espressomd.cuda_init.CudaInitHandle.list_devices" title="espressomd.cuda_init.CudaInitHandle.list_devices"><code class="xref py py-meth docutils literal notranslate"><span class="pre">espressomd.cuda_init.CudaInitHandle.list_devices()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">espressomd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">system</span> <span class="o">=</span> <span class="n">espressomd</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">box_l</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">cuda_init_handle</span><span class="o">.</span><span class="n">list_devices</span><span class="p">())</span>
<span class="go">{0: &#39;GeForce RTX 2080&#39;, 1: &#39;GeForce GT 730&#39;}</span>
</pre></div>
</div>
<p>This method returns a dictionary containing
the device id as key and the device name as its value.</p>
<p>To get more details on the CUDA devices for each MPI node, call
<a class="reference internal" href="espressomd.html#espressomd.cuda_init.CudaInitHandle.list_devices_properties" title="espressomd.cuda_init.CudaInitHandle.list_devices_properties"><code class="xref py py-meth docutils literal notranslate"><span class="pre">espressomd.cuda_init.CudaInitHandle.list_devices_properties()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">pprint</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">espressomd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">system</span> <span class="o">=</span> <span class="n">espressomd</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">box_l</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">pprint</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">system</span><span class="o">.</span><span class="n">cuda_init_handle</span><span class="o">.</span><span class="n">list_devices_properties</span><span class="p">())</span>
<span class="go">{&#39;seraue&#39;: {0: {&#39;name&#39;: &#39;GeForce RTX 2080&#39;,</span>
<span class="go">                &#39;compute_capability&#39;: (7, 5),</span>
<span class="go">                &#39;cores&#39;: 46,</span>
<span class="go">                &#39;total_memory&#39;: 8370061312},</span>
<span class="go">            1: {&#39;name&#39;: &#39;GeForce GT 730&#39;,</span>
<span class="go">                &#39;compute_capability&#39;: (3, 5),</span>
<span class="go">                &#39;cores&#39;: 2,</span>
<span class="go">                &#39;total_memory&#39;: 1014104064}}}</span>
</pre></div>
</div>
</section>
<section id="select-a-device">
<span id="id14"></span><h4><span class="section-number">3.4.1.2. </span>Select a device<a class="headerlink" href="#select-a-device" title="Permalink to this headline">¶</a></h4>
<p>When you start <code class="docutils literal notranslate"><span class="pre">pypresso</span></code>, the first GPU should be selected.
If you wanted to use the second GPU, this can be done
by setting <a class="reference internal" href="espressomd.html#espressomd.cuda_init.CudaInitHandle.device" title="espressomd.cuda_init.CudaInitHandle.device"><code class="xref py py-attr docutils literal notranslate"><span class="pre">espressomd.cuda_init.CudaInitHandle.device</span></code></a> as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">espressomd</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">system</span> <span class="o">=</span> <span class="n">espressomd</span><span class="o">.</span><span class="n">System</span><span class="p">(</span><span class="n">box_l</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">system</span><span class="o">.</span><span class="n">cuda_init_handle</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Setting a device id outside the valid range or a device
which does not meet the minimum requirements will raise
an exception.</p>
</section>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">3. Running a simulation</a><ul>
<li><a class="reference internal" href="#running-es">3.1. Running <em>ESPResSo</em></a><ul>
<li><a class="reference internal" href="#running-a-script">3.1.1. Running a script</a></li>
<li><a class="reference internal" href="#using-the-console">3.1.2. Using the console</a></li>
<li><a class="reference internal" href="#interactive-notebooks">3.1.3. Interactive notebooks</a></li>
<li><a class="reference internal" href="#running-inside-an-ide">3.1.4. Running inside an IDE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#debugging-es">3.2. Debugging <em>ESPResSo</em></a></li>
<li><a class="reference internal" href="#parallel-computing">3.3. Parallel computing</a><ul>
<li><a class="reference internal" href="#general-syntax">3.3.1. General syntax</a></li>
<li><a class="reference internal" href="#performance-gain">3.3.2. Performance gain</a></li>
<li><a class="reference internal" href="#communication-model">3.3.3. Communication model</a></li>
<li><a class="reference internal" href="#debugging-parallel-code">3.3.4. Debugging parallel code</a></li>
</ul>
</li>
<li><a class="reference internal" href="#gpu-acceleration">3.4. GPU acceleration</a><ul>
<li><a class="reference internal" href="#cuda-acceleration">3.4.1. CUDA acceleration</a></li>
</ul>
</li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018-2023, The ESPResSo project.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>