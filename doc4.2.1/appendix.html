
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>23. Appendix &#8212; ESPResSo 4.2.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="_static/blockquotes.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/toggleprompt.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="24. Bibliography" href="bibliography.html" />
    <link rel="prev" title="22. Contributing" href="contributing.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="appendix">
<span id="id1"></span><h1><span class="section-number">23. </span>Appendix<a class="headerlink" href="#appendix" title="Permalink to this headline">¶</a></h1>
<section id="the-mmm-family-of-algorithms">
<span id="id2"></span><h2><span class="section-number">23.1. </span>The MMM family of algorithms<a class="headerlink" href="#the-mmm-family-of-algorithms" title="Permalink to this headline">¶</a></h2>
<section id="introduction">
<span id="mmm-introduction"></span><h3><span class="section-number">23.1.1. </span>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h3>
<p>In the MMM family of algorithms for the electrostatic interaction, a
convergence factor approach to tackle the conditionally convergent
Coulomb sum is used (even the authors of the original MMM method have no
idea what this acronym stands for). Instead of defining the summation
order, one multiplies each summand by a continuous factor
<span class="math notranslate nohighlight">\(c(\beta,r_{ij},n_{klm})\)</span> such that the sum is absolutely
convergent for <span class="math notranslate nohighlight">\(\beta&gt;0\)</span>, but <span class="math notranslate nohighlight">\(c(0,.,.)=1\)</span>. The energy is
then defined as the limit <span class="math notranslate nohighlight">\(\beta\rightarrow 0\)</span> of the sum, i.e.
<span class="math notranslate nohighlight">\(\beta\)</span> is an artificial convergence parameter. For a convergence
factor of <span class="math notranslate nohighlight">\(e^{-\beta n_{klm}^2}\)</span> the limit is the same as the spherical
limit, and one can derive the classical Ewald method quite conveniently through
this approach <span id="id3">[<a class="reference internal" href="bibliography.html#id81" title="E. R. Smith. Electrostatic energy in ionic crystals. Proceedings of the Royal Society of London A: Mathematical and Physical Sciences, 375:475–505, 1981. doi:10.1098/rspa.1981.0064.">Smith, 1981</a>]</span>. To derive the formulas for MMM,
one has to use a different convergence factor, namely
<span class="math notranslate nohighlight">\(e^{-\beta|r_{ij}+n_{klm}|}\)</span>, which defines the alternative energy</p>
<div class="math notranslate nohighlight">
\[\tilde{E}=\,\frac{1}{2}\lim_{\beta\rightarrow
  0}\sum_{k,l,m}{\sum_{i,j=1}^N}' \frac{q_i q_je^{-\beta|p_{ij} +
    n_{klm}|}} {|p_{ij} + n_{klm}|}
=:\,\frac{1}{2}\lim_{\beta\rightarrow 0}\sum_{i,j=1}^N
q_iq_j\phi_\beta(x_{ij}, y_{ij},z_{ij}).\]</div>
<p><span class="math notranslate nohighlight">\(\phi_\beta\)</span> is given by
<span class="math notranslate nohighlight">\(\phi_\beta(x,y,z)=\,\tilde\phi_\beta(x,y,z)
+ \frac{e^{-\beta r}}{r}\)</span> for <span class="math notranslate nohighlight">\((x,y,z)\neq 0\)</span> and
<span class="math notranslate nohighlight">\(\phi_\beta(0,0,0)=\,\tilde\phi_\beta(0,0,0)\)</span>, where</p>
<div class="math notranslate nohighlight">
\[\tilde\phi_\beta(x,y,z)=\,\sum_{(k,l,m)\neq 0} \frac{e^{-\beta
    r_{klm}}}{r_{klm}}.\]</div>
<p>The limit <span class="math notranslate nohighlight">\(\tilde{E}\)</span> exists, but differs for three-dimensionally
periodic systems by some multiple of the square of the dipole moment
from the spherical limit as obtained by the Ewald
summation <span id="id4">[<a class="reference internal" href="bibliography.html#id81" title="E. R. Smith. Electrostatic energy in ionic crystals. Proceedings of the Royal Society of London A: Mathematical and Physical Sciences, 375:475–505, 1981. doi:10.1098/rspa.1981.0064.">Smith, 1981</a>]</span>. From the physical point of view
the Coulomb interaction is replaced by a screened Coulomb interaction
with screening length <span class="math notranslate nohighlight">\(1/\beta\)</span>. <span class="math notranslate nohighlight">\(\tilde{E}\)</span> is then the
energy in the limit of infinite screening length. But because of the
conditional convergence of the electrostatic sum, this is not
necessarily the same as the energy of an unscreened system. Since the
difference to the Ewald methods only depends on the dipole moment of the
system, the correction can be calculated easily in linear time and can
be ignored with respect to accuracy as well as to computation time.</p>
<p>For one- or two-dimensionally systems, however, <span class="math notranslate nohighlight">\(\tilde{E}=E\)</span>, the
convergence factor approach equals the spherical summation limit of the
Ewald sum, and MMM1D and MMM2D do not require a dipole correction.</p>
<p>Starting from this convergence factor approach, Strebel constructed a
method of computational order <span class="math notranslate nohighlight">\(O(N\log N)\)</span>, which is called MMM
<span id="id5">[<a class="reference internal" href="bibliography.html#id86" title="R. Strebel. Pieces of software for the Coulombic m body problem. Dissertation, ETH Zürich, 1999. doi:10.3929/ethz-a-003856704.">Strebel, 1999</a>]</span>. The favorable scaling is obtained,
very much like in the Ewald case, by technical tricks in the calculation
of the far formula. The far formula has a product decomposition and can
be evaluated hierarchically similarly to the fast multipole methods.</p>
<p>For particles sufficiently separated in the z-axis one can Fourier
transform the potential along both x and y. We obtain the far formula as</p>
<div class="math notranslate nohighlight">
\[\phi(x,y,z) =\, u_x u_y\sum_{p,q\neq 0} \frac{e^{2\pi f_{pq}z} +
  e^{2\pi f_{pq}(\lambda_z-z)}}{f_{pq} \left(e^{2\pi f_{pq}\lambda_z}
    - 1\right)} e^{2\pi i u_y q y}e^{2\pi i u_x p x} + 2\pi u_x
u_y\left(u_z z^2 - z + \frac{\lambda_z}{6}\right).\]</div>
<p>where <span class="math notranslate nohighlight">\(\lambda_{x,y,z}\)</span> are the box dimensions, <span class="math notranslate nohighlight">\(f_{pq} =\,
\sqrt{(u_x p)^2 + (u_y q)^2},\quad f_p =\, u_x p,\quad f_q =\, u_x q\)</span>,
<span class="math notranslate nohighlight">\(\omega_p=2\pi u_x p\)</span> and <span class="math notranslate nohighlight">\(\omega_q=2\pi u_y q\)</span>. The
advantage of this formula is that it allows for a product decomposition
into components of the particles. For example</p>
<div class="math notranslate nohighlight">
\[e^{2\pi f_{pq}z}=e^{2\pi f_{pq}(z_i-z_j)}=e^{2\pi
  f_{pq}z_i}e^{-2\pi f_{pq}z_j}\]</div>
<p>etc. Therefore one just has to calculate the sum over all these
exponentials on the left side and on the right side and multiply them
together, which can be done in <span class="math notranslate nohighlight">\(O(N)\)</span> computation time. As can be
seen easily, the convergence of the series is excellent as long as z is
sufficiently large. By symmetry one can choose the coordinate with the
largest distance as z to optimize the convergence. Similar to the Lekner
sum, we need a different formula if all coordinates are small, i.e. for
particles close to each other. For sufficiently small <span class="math notranslate nohighlight">\(u_y\rho\)</span>
and <span class="math notranslate nohighlight">\(u_xx\)</span> we obtain the near formula as</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rl} \tilde\phi(x,y,z)=\, &amp; 2 u_x
  u_y\sum\limits_{p,q&gt;0} \frac{\cosh(2\pi f_{pq}z)}{f_{pq}
    \left(e^{2\pi f_{pq}\lambda_z} - 1\right)} e^{2\pi i u_y q
    y}e^{2\pi i u_x p x} +\\ &amp; 4u_x\sum\limits_{l,p&gt;0}\left(K_0(2\pi
    u_x p\rho_l) + K_N(2\pi u_x p\rho_{-l})\right)cos(2\pi u_x p x)
  -\\ &amp; 2u_x\sum\limits_{n\ge 1}\frac{b_{2n}}{2n(2n)!}\Re\bigl((2\pi
  u_y (z+iy))^{2n}\bigr) +\\ &amp; u_x\sum\limits_{n\ge
    0}\left(\begin{array}{c}-\frac{1}{2}\\
      n\end{array}\right)\frac{\left( \psi^{(2n)}(1 + u_x x) +
      \psi^{(2n)}(1 - u_x x)\right)}{(2n)!}\rho^{2n} -\\ &amp;
  2\log(4\pi). \end{array}\end{split}\]</div>
<p>Note that this time we calculate <span class="math notranslate nohighlight">\(\tilde{\phi}\)</span> instead of
<span class="math notranslate nohighlight">\(\phi\)</span>, i.e. we omit the contribution of the primary simulation
box. This is very convenient as it includes the case of self energy and
makes <span class="math notranslate nohighlight">\(\tilde{\phi}\)</span> a smooth function. To obtain <span class="math notranslate nohighlight">\(\phi\)</span> one
has to add the <span class="math notranslate nohighlight">\(1/r\)</span> contribution of the primary box. The self
energy is given by</p>
<div class="math notranslate nohighlight">
\[\tilde\phi(0,0,0)=\, 2 u_x u_y\sum\limits_{p,q&gt;0} \frac{1}{f_{pq}
  \left(e^{2\pi f_{pq}\lambda_z} - 1\right)}+
8u_x\sum\limits_{l,p&gt;0}K_N(2\pi u_x\lambda_y p l) + 2 u_x\psi^{(0)}(1)
- 2\log(4\pi).\]</div>
<p>Both the near and far formula are derived using the same convergence
factor approach, and consequently the same singularity in <span class="math notranslate nohighlight">\(\beta\)</span>
is obtained. This is important since otherwise the charge neutrality
argument does not hold.</p>
<p>To obtain the <span class="math notranslate nohighlight">\(O(N\log N)\)</span> scaling, some algorithm tricks are
needed, which are not used in MMM1D, MMM2D or ELC and are therefore not
discussed here. For details, see <span id="id6">[<a class="reference internal" href="bibliography.html#id86" title="R. Strebel. Pieces of software for the Coulombic m body problem. Dissertation, ETH Zürich, 1999. doi:10.3929/ethz-a-003856704.">Strebel, 1999</a>]</span>.</p>
</section>
<section id="mmm2d-theory">
<span id="id7"></span><h3><span class="section-number">23.1.2. </span>MMM2D theory<a class="headerlink" href="#mmm2d-theory" title="Permalink to this headline">¶</a></h3>
<p>In the case of periodicity only in the x and y directions, the far
formula looks like</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rl} \phi(x,y,z) = \, &amp; 4 u_x u_y\sum_{p,q&gt;0}
  \frac{e^{-2\pi f_{pq}|z|}} {f_{pq}} \cos(\omega_p x)\cos(\omega_q y)
  +\\ &amp; 2 u_x u_y\left(\sum_{q&gt;0} \frac{e^{-2\pi f_q|z|}}{f_q}
    \cos(\omega_q y) + \sum_{p&gt;0} \frac{e^{-2\pi f_p|z|}}{f_p}
    \cos(\omega_p x)\right) -\\ &amp; 2\pi u_x u_y |z|, \end{array}\end{split}\]</div>
<p>and the near formula is</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rl} \tilde\phi(x,y,z)=\, &amp;
  4u_x\sum_{l,p&gt;0}\left(K_0(\omega_p\rho_l) +
    K_0(\omega_p\rho_{-l})\right)\cos(\omega_p x) -\\ &amp; 2u_x\sum_{n\ge
    1}\frac{b_{2n}}{2n(2n)!} \Re\bigl((2\pi u_y
  (z+iy))^{2n}\bigr)\,+\, \sum_{k=1}^{N_\psi-1}\left(\frac{1}{r_{k}} +
    \frac{1}{r_{-k}}\right) -\\ &amp; u_x\sum_{n\ge
    0}\left(\begin{array}{c}-\frac{1}{2}\\n\end{array}\right)\frac{\left(
      \psi^{(2n)}(N_\psi + u_x x) + \psi^{(2n)}(N_\psi - u_x
      x)\right)}{(2n)!}(u_x\rho)^{2n} -\\ &amp;
  2u_x\log\left(4\pi\frac{u_y}{u_x}\right). \end{array}\end{split}\]</div>
<p>As said before, the energy obtained from these potentials is equal to
the electrostatic energy obtained by the spherical summation limit. The
deeper reason for this is that in some sense the electrostatic sum is
absolutely convergent <span id="id8">[<a class="reference internal" href="bibliography.html#id7" title="Axel Arnold and Christian Holm. MMM2D: a fast and accurate summation method for electrostatic interactions in 2D slab geometries. Computer Physics Communications, 148(3):327–348, 2002. doi:10.1016/S0010-4655(02)00586-6.">Arnold and Holm, 2002</a>]</span>.</p>
<p>The near formula is used for particles with a small distance along the z
axis, for all other particles the far formula is used. Below is shown,
that the far formula can be evaluated much more efficiently, however,
its convergence breaks down for small z distance. To efficiently
implement MMM2D, the layered cell system is required, which splits up
the system in equally sized gaps along the z axis. The interaction of
all particles in a layer S with all particles in the layers S-1,S,S+1 is
calculated using the near formula, for the particles in layers
<span class="math notranslate nohighlight">\(1,\dots,S-2\)</span>, and in layers <span class="math notranslate nohighlight">\(S+2,\dots,N\)</span>, the far formula
is used.</p>
<p>The implementation of the near formula is relatively straight forward
and can be treated as any short ranged force is treated using the link
cell algorithm, here in the layered variant. The special functions in
the formula are somewhat demanding, but for the polygamma functions
Taylor series can be achieved, which are implemented in <code class="file docutils literal notranslate"><span class="pre">mmm-common.hpp</span></code>.
The Bessel functions are calculated using a Chebychev series.</p>
<p>The treatment of the far formula is algorithmically more complicated.
For a particle i in layer <span class="math notranslate nohighlight">\(S_i\)</span>, the formula can product
decomposed, as in</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rl} \sum_{j\in I_S, S &lt; S_i - 1} q_iq_j\frac{e^{-2\pi
      f_{pq}|z_i-z_j|}}{f_{pq}} \cos(\omega_p (x_i -
  x_j))\cos(\omega_q (y_i - y_j)) = \\
  q_i\frac{e^{-2\pi f_{pq}z_i}}{f_{pq}} \cos(\omega_p
  x_i)\cos(\omega_q y_i) \sum_{j\in I_S, S &lt; S_i - 1}q_je^{2\pi
    f_{pq}z_j} \cos(\omega_p x_j)\cos(\omega_q y_j) + \\
  q_i\frac{e^{-2\pi f_{pq}z_i}}{f_{pq}} \cos(\omega_p
  x_i)\sin(\omega_q y_i) \sum_{j\in I_S, S &lt; S_i - 1}q_je^{2\pi
    f_{pq}z_j} \cos(\omega_p x_j)\sin(\omega_q y_j) + \\
  q_i\frac{e^{-2\pi f_{pq}z_i}}{f_{pq}} \sin(\omega_p
  x_i)\cos(\omega_q y_i) \sum_{j\in I_S, S &lt; S_i - 1}q_je^{2\pi
    f_{pq}z_j} \sin(\omega_p x_j)\cos(\omega_q y_j) + \\
  q_i\frac{e^{-2\pi f_{pq}z_i}}{f_{pq}} \sin(\omega_p
  x_i)\sin(\omega_q y_i) \sum_{j\in I_S, S &lt; S_i - 1}q_je^{2\pi
    f_{pq}z_j} \sin(\omega_p x_j)\sin(\omega_q y_j). \end{array}\end{split}\]</div>
<p>This representation has the advantage, that the contributions of the two
particles are decoupled. For all particles j only the eight terms</p>
<div class="math notranslate nohighlight">
\[\xi^{(\pm,s/c,s/c)}_j= q_je^{\pm 2\pi f_{pq}z_j} \sin/\cos(\omega_p
x_j)\sin/\cos(\omega_q y_j)\]</div>
<p>are needed. The upper index describes the sign of the exponential term
and whether sine or cosine is used for <span class="math notranslate nohighlight">\(x_j\)</span> and <span class="math notranslate nohighlight">\(y_j\)</span> in
the obvious way. These terms can be used for all expressions on the
right hand side of the product decomposition. Moreover it is easy to see
from the addition theorem for the sine function that these terms also
can be used to calculate the force information up to simple prefactors
that depend only on p and q.</p>
<p>Every processor starts with the calculation of the terms
<span class="math notranslate nohighlight">\(\xi^{(\pm,s/c,s/c)}_j\)</span> and adds them up in each layer, so that
one obtains</p>
<div class="math notranslate nohighlight">
\[\Xi^{(\pm,s/c,s/c)}_s= \sum_{j\in S_s}\xi^{(\pm,s/c,s/c)}_j.\]</div>
<p>Now we calculate</p>
<div class="math notranslate nohighlight">
\[\Xi^{(l,s/c,s/c)}_s=\sum_{t &lt; s - 1}\Xi^{(+,s/c,s/c)}_t\]</div>
<p>and</p>
<div class="math notranslate nohighlight">
\[\Xi^{(h,s/c,s/c)}_s=\sum_{t &gt; s + 1}\Xi^{(-,s/c,s/c)}_t,\]</div>
<p>which are needed for the evaluation of the product decomposition. While
the bottom processor can calculate <span class="math notranslate nohighlight">\(\Xi^{(l,s/c,s/c)}_s\)</span> directly,
the other processors are dependent on its results. Therefore the bottom
processor starts with the calculation of its <span class="math notranslate nohighlight">\(\Xi^{(l,s/c,s/c)}_s\)</span>
and sends up <span class="math notranslate nohighlight">\(\Xi^{(l,s/c,s/c)}_s\)</span> and <span class="math notranslate nohighlight">\(\Xi^{(+,s/c,s/c)}_s\)</span>
of its top layer s to the next processor dealing with the layers above.
Simultaneously the top processor starts with the calculation of the
<span class="math notranslate nohighlight">\(\Xi^{(h,s/c,s/c)}_s\)</span> and sends them down. After the communicated
has been completed, every processor can use the
<span class="math notranslate nohighlight">\(\Xi^{(l/h,s/c,s/c)}_j\)</span> and the <span class="math notranslate nohighlight">\(\xi^{(\pm,s/c,s/c)}_j\)</span> to
calculate the force rsp. energy contributions for its particles.</p>
<p>In pseudo code, the far formula algorithm looks like:</p>
<ol class="arabic">
<li><p>for each layer <span class="math notranslate nohighlight">\(s=1,\ldots,S\)</span></p>
<ol class="arabic simple">
<li><p><span class="math notranslate nohighlight">\(\Xi^{(\pm,s/c,s/c)}_s=0\)</span></p></li>
<li><p>for each particle <span class="math notranslate nohighlight">\(j\)</span> in layer <span class="math notranslate nohighlight">\(s\)</span></p>
<ol class="arabic simple">
<li><p>calculate <span class="math notranslate nohighlight">\(\xi^{(\pm,s/c,s/c)}_j\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\Xi^{(\pm,s/c,s/c)}_s += \xi^{(\pm,s/c,s/c)}_j\)</span></p></li>
</ol>
</li>
</ol>
</li>
<li><p><span class="math notranslate nohighlight">\(\Xi^{(l,s/c,s/c)}_3=\Xi^{(+,s/c,s/c)}_1\)</span></p></li>
<li><p>for each layer <span class="math notranslate nohighlight">\(s=4,\ldots,S\)</span></p>
<ol class="arabic">
<li><div class="math notranslate nohighlight">
\[\Xi^{(l,s/c,s/c)}_s=\Xi^{(l,s/c,s/c)}_{s-1} +\
 \Xi^{(+,s/c,s/c)}_{s-2}\]</div>
</li>
</ol>
</li>
<li><p><span class="math notranslate nohighlight">\(\Xi^{(l,s/c,s/c)}_{S-2}=\Xi^{(-,s/c,s/c)}_S\)</span></p></li>
<li><p>for each layer <span class="math notranslate nohighlight">\(s=(S-3),...,1\)</span></p>
<ol class="arabic">
<li><div class="math notranslate nohighlight">
\[\Xi^{(l,s/c,s/c)}_s=\Xi^{(l,s/c,s/c)}_{s+1} +\
 \Xi^{(-,s/c,s/c)}_{s+2}\]</div>
</li>
</ol>
</li>
<li><p>for each layer <span class="math notranslate nohighlight">\(s=1,...,S\)</span></p>
<ol class="arabic simple">
<li><p>for each particle <span class="math notranslate nohighlight">\(j\)</span> in layer <span class="math notranslate nohighlight">\(s\)</span></p>
<ol class="arabic simple">
<li><p>calculate particle interaction from
<span class="math notranslate nohighlight">\(\xi^{(+,s/c,s/c)}_j\Xi^{(l,s/c,s/c)}_s\)</span> and
<span class="math notranslate nohighlight">\(\xi^{(-,s/c,s/c)}_j\Xi^{(h,s/c,s/c)}_s\)</span></p></li>
</ol>
</li>
</ol>
</li>
</ol>
<p>For further details, see <span id="id9">[<a class="reference internal" href="bibliography.html#id10" title="A. Arnold, J. de Joannis, and C. Holm. Electrostatics in periodic slab geometries II. The Journal of Chemical Physics, 117:2503–2512, 2002. doi:10.1063/1.1491954.">Arnold <em>et al.</em>, 2002</a>, <a class="reference internal" href="bibliography.html#id9" title="A. Arnold, J. de Joannis, and C. Holm. Electrostatics in periodic slab geometries I. The Journal of Chemical Physics, 117:2496–2502, 2002. doi:10.1063/1.1491955.">Arnold <em>et al.</em>, 2002</a>, <a class="reference internal" href="bibliography.html#id8" title="Axel Arnold and Christian Holm. A novel method for calculating electrostatic interactions in 2D periodic slab geometries. Chemical Physics Letters, 354:324–330, 2002. doi:10.1016/S0009-2614(02)00131-8.">Arnold and Holm, 2002</a>, <a class="reference internal" href="bibliography.html#id7" title="Axel Arnold and Christian Holm. MMM2D: a fast and accurate summation method for electrostatic interactions in 2D slab geometries. Computer Physics Communications, 148(3):327–348, 2002. doi:10.1016/S0010-4655(02)00586-6.">Arnold and Holm, 2002</a>]</span>.</p>
<section id="dielectric-contrast">
<span id="id10"></span><h4><span class="section-number">23.1.2.1. </span>Dielectric contrast<a class="headerlink" href="#dielectric-contrast" title="Permalink to this headline">¶</a></h4>
<p>A dielectric contrast at the lower and/or upper simulation box boundary
can be included comparatively easy by using image charges. Apart from
the images of the lowest and topmost layer, the image charges are far
enough to be treated by the far formula, and can be included as starting
points in the calculation of the <span class="math notranslate nohighlight">\(\Xi\)</span> terms. The remaining
particles from the lowest and topmost layer are treated by direct
summation of the near formula.</p>
<p>This means, that in addition to the algorithm above, one has to only a
few things: during the calculation of the particle and cell blocks
<span class="math notranslate nohighlight">\(\xi\)</span> and <span class="math notranslate nohighlight">\(\Xi\)</span>, one additionally calculates the
contributions of the image charges and puts them either in a separate
array or, for the boundary layers, into two extra <span class="math notranslate nohighlight">\(\xi\)</span> cell
blocks outside the simulation box. The entries in the separate array are
then added up over all processors and stored in the <span class="math notranslate nohighlight">\(\Xi\)</span>-terms of
the lowest/topmost layer. This are all modifications necessary for the
far formula part. In addition to the far formula part, there is an
additional loop over the particles at the boundary to directly calculate
their interactions with their images. For details, refer to
<span id="id11">[<a class="reference internal" href="bibliography.html#id93" title="S. Tyagi, A. Arnold, and C. Holm. ICMMM2D: an accurate method to include planar dielectric interfaces via image charge summation. The Journal of Chemical Physics, 127:154723, 2007. doi:10.1063/1.2790428.">Tyagi <em>et al.</em>, 2007</a>]</span>.</p>
</section>
</section>
<section id="mmm1d-theory">
<span id="id12"></span><h3><span class="section-number">23.1.3. </span>MMM1D theory<a class="headerlink" href="#mmm1d-theory" title="Permalink to this headline">¶</a></h3>
<p>In one-dimensionally periodic systems with z being the periodic
coordinate, the far formula looks like</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rl} \phi(\rho,z) &amp;=\, 4 u_z\sum_{p\neq 0}
  K_0(\omega\rho)\cos(\omega z) - 2u_z\log(\frac{\rho}{2\lambda_z}) -
  2u_z\gamma\\ F_\rho(\rho,z) &amp;=\, 8\pi u_z^2\sum_{p\neq 0} p
  K_1(\omega\rho)\cos(\omega z) + \frac{2 u_z}{\rho}\\ F_z(\rho,z)
  &amp;=\, 8\pi u_z^2 \sum_{p\neq 0} pK_0(\omega\rho)\sin(\omega z),
\end{array}\end{split}\]</div>
<p>the near formula is</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rl} \tilde{\phi}(\rho,z) &amp;=\, -u_z\sum_{n\ge 0}
  \left(\begin{array}{c}-\frac{1}{2}\\n\end{array}\right)
  \frac{\left(\psi^{(2n)}(N_\psi + u_z z) + \psi^{(2n)}(N_\psi - u_z
      z)\right)}{(2n)!}(u_z\rho)^{2n} - 2u_z\gamma + \\
  &amp;\phantom{=\,++}
  \sum_{k=1}^{N_\psi-1}\left(\frac{1}{r_k}+\frac{1}{r_{-k}}\right)\\
  \tilde{F}_\rho(\rho,z) &amp;=\, -u_z^3 \sum_{n\ge 0}
  \left(\begin{array}{c}-\frac{1}{2}\\n\end{array}\right)
  \frac{\left(\psi^{(2n)}(N_\psi + u_z z) + \psi^{(2n)}(N_\psi - u_z
      z)\right)}{(2n)!}(u_z\rho)^{2n-1} + \\ &amp;\phantom{=\,++}
  \sum_{k=1}^{N_\psi-1}\left(\frac{\rho}{r_k^3}+\frac{\rho}{r_{-k}^3}\right)
  \\ \tilde{F}_z(\rho,z) &amp;=\, -u_z^2 \sum_{n\ge 0}
  \left(\begin{array}{c}-\frac{1}{2}\\n\end{array}\right)
  \frac{\left(\psi^{(2n + 1)}(N_\psi + u_z z) + \psi^{(2n + 1)}(N_\psi
      - u_z z)\right)}{(2n)!}(u_z\rho)^{2n} + \\ &amp;\phantom{=\,++}
  \sum_{k=1}^{N_\psi-1}\left(\frac{z+k\lambda_z}{r_k^3}+\frac{z-k\lambda_z}{r_{-k}^3}\right),
\end{array}\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\rho\)</span> denotes the xy-distance of the particles. As for the
two-dimensional periodic case, the obtained energy is equal to the
one-dimensional Ewald sum. Algorithmically, MMM1D is uninteresting, since
neither the near nor far formula allow a product decomposition or
similar tricks. MMM1D has to be implemented as a simple NxN loop.
However, the formulas can be evaluated efficiently, so that MMM1D can
still be used reasonably for up to 400 particles on a single processor
<span id="id13">[<a class="reference internal" href="bibliography.html#id11" title="A. Arnold and C. Holm. MMM1D: A method for calculating electrostatic interactions in one-dimensional periodic geometries. The Journal of Chemical Physics, 123(12):144103, 2005. doi:10.1063/1.2052647.">Arnold and Holm, 2005</a>]</span>.</p>
</section>
<section id="elc-theory">
<span id="id14"></span><h3><span class="section-number">23.1.4. </span>ELC theory<a class="headerlink" href="#elc-theory" title="Permalink to this headline">¶</a></h3>
<p>The ELC method differs from the other MMM algorithms in that it is not
an algorithm for the calculation of the electrostatic interaction, but
rather represents a correction term which allows to use any method for
three-dimensionally periodic systems with spherical summation order for
two-dimensional periodicity. The basic idea is to expand the
two-dimensional slab system of height h in the non-periodic z-coordinate to
a system with periodicity in all three dimensions, with a period of
<span class="math notranslate nohighlight">\(\lambda_z &gt; h\)</span>, which leaves an empty gap of height
<span class="math notranslate nohighlight">\(\delta = \lambda_z - h\)</span> above the particles in the simulation box.</p>
<p>Since the electrostatic potential is only finite if the total system is
charge neutral, the additional image layers (those layers above or below
the original slab system) are charge neutral, too. Now let us consider
the n-th image layer which has an offset of <span class="math notranslate nohighlight">\(n\lambda_z\)</span> to the
original layer. If <span class="math notranslate nohighlight">\(n\lambda_z\)</span> is large enough, each particle of
charge <span class="math notranslate nohighlight">\(q_j\)</span> at position <span class="math notranslate nohighlight">\((x_j,y_j,z_j+n\lambda_z)\)</span> and its
replicas in the xy-plane can be viewed as constituting a homogeneous
charged sheet of charge density
<span class="math notranslate nohighlight">\(\sigma_j = \frac{q_j}{\lambda_x\lambda_y}\)</span>. The potential of such
a charged sheet at distance <span class="math notranslate nohighlight">\(z\)</span> is <span class="math notranslate nohighlight">\(2\pi \sigma_j |z|\)</span>.
Now we consider the contribution from a pair of image layers
located at <span class="math notranslate nohighlight">\(\pm n\lambda_z\)</span>, n&gt;0 to the energy of a charge <span class="math notranslate nohighlight">\(q_i\)</span> at
position <span class="math notranslate nohighlight">\((x_i,y_i,z_i)\)</span> in the central layer. Since
<span class="math notranslate nohighlight">\(|z_j - z_i| &lt; n\lambda_z\)</span>, we have
<span class="math notranslate nohighlight">\(|z_j - z_i + n\lambda_z| = n\lambda_z + z_j - z_i\)</span>
and <span class="math notranslate nohighlight">\(|z_j - z_i - n\lambda_z|= n\lambda_z - z_j + z_i\)</span>, and
hence the interaction energy from those two image layers with the charge
<span class="math notranslate nohighlight">\(q_i\)</span> vanishes by charge neutrality:</p>
<div class="math notranslate nohighlight">
\[2\pi q_i \sum_{j=1}^N \sigma_j(|z_j - z_i + n\lambda_z| + |z_j -
z_i - n\lambda_z|) = 4\pi q_i n\lambda_z \sum_{j=1}^N \sigma_j = 0.\]</div>
<p>The only errors occurring are those coming from the approximation of
assuming homogeneously charged, infinite sheets instead of discrete
charges. This assumption should become better when increasing the
distance <span class="math notranslate nohighlight">\(n\lambda_z\)</span> from the central layer.</p>
<p>However, in a naive implementation, even large gap sizes will result in
large errors. This is due to the order of summation for the standard
Ewald sum, which is spherical, while the above approach orders the cells
in layers, called slab-wise summation. Smith has shown that by adding to
the Ewald energy the term</p>
<div class="math notranslate nohighlight">
\[E_c=2\pi M_z^2 - \frac{2\pi M^2}{3},\]</div>
<p>where M is the total dipole moment, one obtains the result of a
slab-wise summation instead of the spherical limit
<span id="id15">[<a class="reference internal" href="bibliography.html#id81" title="E. R. Smith. Electrostatic energy in ionic crystals. Proceedings of the Royal Society of London A: Mathematical and Physical Sciences, 375:475–505, 1981. doi:10.1098/rspa.1981.0064.">Smith, 1981</a>]</span>. Although this is a major change in the
summation order, the difference is a very simple term. In fact, Smith
shows that changes of the summation order always result in a difference
that depends only on the total dipole moment.</p>
<p>Using the far formula of MMM2D, one can calculate the contributions of
the additional layers up to arbitrarily precision, even for small gap
sizes. This method is called electrostatic layer correction, ELC. The
advantage of this approach is that for the image layers, z is
necessarily large enough, so that all interactions can be represented
using the product decomposition. This allows for an order N evaluation
of the ELC term.</p>
<p>The electrostatic layer correction term is given by</p>
<div class="math notranslate nohighlight">
\[E_{lc}=\sum_{i,j=1}^Nq_iq_j\psi(p_i-p_j),\]</div>
<p>where</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{array}{rl} \psi(x,y,z)=&amp;4u_xu_y\sum_{p,q&gt;0}\frac{\cosh(2\pi
    f_{pq}z)}{f_{pq}(e^{2\pi f_{pq}\lambda_z} - 1)} \cos(\omega_p
  x)\cos(\omega_q y) + \\ &amp;2u_xu_y\sum_{p&gt;0}\frac{\cosh(2\pi f_p
    z)}{f_p(e^{2\pi f_p\lambda_z} - 1)}\cos(\omega_p x)+\\
  &amp;2u_xu_y\sum_{q&gt;0}\frac{\cosh(2\pi f_q z)}{f_q(e^{2\pi f_q\lambda_z}
    - 1)}\cos(\omega_q y). \end{array}\end{split}\]</div>
<p>The implementation is very similar to MMM2D, except that the separation
between slices close by, and above and below is not necessary.</p>
</section>
<section id="errors">
<span id="id16"></span><h3><span class="section-number">23.1.5. </span>Errors<a class="headerlink" href="#errors" title="Permalink to this headline">¶</a></h3>
<p>Common to all algorithms of the MMM family is that accuracy is cheap
with respect to computation time. More precisely, the maximal pairwise
error, i.e. the maximal error of the <span class="math notranslate nohighlight">\(\psi\)</span> expression decreases
exponentially with the cutoffs. In turn, the computation time grows
logarithmically with the accuracy. This is quite in contrast to the
Ewald methods, for which decreasing the error bound can lead to
excessive computation time. For example, P3M cannot reach a precision
beyond <span class="math notranslate nohighlight">\(10^{-5}\)</span> in general. The precise form of the error
estimates is of little importance here, for details see
<span id="id17">[<a class="reference internal" href="bibliography.html#id10" title="A. Arnold, J. de Joannis, and C. Holm. Electrostatics in periodic slab geometries II. The Journal of Chemical Physics, 117:2503–2512, 2002. doi:10.1063/1.1491954.">Arnold <em>et al.</em>, 2002</a>, <a class="reference internal" href="bibliography.html#id9" title="A. Arnold, J. de Joannis, and C. Holm. Electrostatics in periodic slab geometries I. The Journal of Chemical Physics, 117:2496–2502, 2002. doi:10.1063/1.1491955.">Arnold <em>et al.</em>, 2002</a>]</span>.</p>
<p>One important aspect is that the error estimates are also exponential in
the non-periodic coordinate. Since the number of close by and far away
particles is different for particles near the border and in the center
of the system, the error distribution is highly non-homogeneous. This is
unproblematic as long as the maximal error is really much smaller than
the thermal energy. However, one cannot interpret the error simply as an
additional error source.</p>
<figure class="align-center" id="id18">
<a class="reference internal image-reference" href="_images/elc-errordist.pdf"><img alt="Error distribution of the ELC method." src="_images/elc-errordist.pdf" style="height: 6.00000cm;" /></a>
<figcaption>
<p><span class="caption-text">Error distribution of the ELC method.</span><a class="headerlink" href="#id18" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>The figure shows the error distribution of the ELC method
for a gap size of <span class="math notranslate nohighlight">\(10\%\)</span> of the total system height. For MMM2D and
MMM1D the error distribution is less homogeneous, however, also here it
is always better to have some extra precision, especially since it is
computationally cheap.</p>
</section>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">23. Appendix</a><ul>
<li><a class="reference internal" href="#the-mmm-family-of-algorithms">23.1. The MMM family of algorithms</a><ul>
<li><a class="reference internal" href="#introduction">23.1.1. Introduction</a></li>
<li><a class="reference internal" href="#mmm2d-theory">23.1.2. MMM2D theory</a></li>
<li><a class="reference internal" href="#mmm1d-theory">23.1.3. MMM1D theory</a></li>
<li><a class="reference internal" href="#elc-theory">23.1.4. ELC theory</a></li>
<li><a class="reference internal" href="#errors">23.1.5. Errors</a></li>
</ul>
</li>
</ul>
</li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018-2023, The ESPResSo project.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>