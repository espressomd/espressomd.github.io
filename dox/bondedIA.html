<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ESPResSo: Bonded interactions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js", "TeX/AMSmath.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen_extra.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="logo_100x100.png"/></td>
  <td id="projectalign">
   <div id="projectname">ESPResSo
   </div>
   <div id="projectbrief">Extensible Simulation Package for Research on Soft Matter Systems</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('bondedIA.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Bonded interactions</div></div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#bondedIA_new">Adding new interactions</a><ul><li class="level2"><a href="#bondedIA_new_struct">Defining the new interaction</a></li>
<li class="level2"><a href="#bondedIA_new_integration">Integrating the new bond type into the C++ core</a></li>
<li class="level2"><a href="#bondedIA_new_script_interface">Registering the new interaction in the ScriptInterface</a></li>
<li class="level2"><a href="#bondedIA_new_interface">Adding the interaction in the Python interface</a></li>
</ul>
</li>
<li class="level1"><a href="#bondedIA_bond_angles">Bond angle potentials</a><ul><li class="level2"><a href="#bondedIA_angle_force">General expressions for the forces</a></li>
<li class="level2"><a href="#bondedIA_angle_potentials">Available potentials</a><ul><li class="level3"><a href="#bondedIA_angle_harmonic">Harmonic angle potential</a></li>
<li class="level3"><a href="#bondedIA_angle_cossquare">Harmonic cosine potential</a></li>
<li class="level3"><a href="#bondedIA_angle_cosine">Cosine potential</a></li>
<li class="level3"><a href="#bondedIA_angle_tab">Tabulated potential</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><h1><a class="anchor" id="bondedIA_new"></a>
Adding new interactions</h1>
<p>To add a new bonded interaction, the following steps are required:</p><ul>
<li>C++ core:<ul>
<li>Create a new header file for your new bond type, preferably inside the folder <code>src/core/bonded_interactions</code>.</li>
<li>Define a data structure for the interaction parameters (prefactors, etc.).</li>
<li>Write a constructor and force/energy kernels.</li>
<li>Add calls to these kernels in the force, energy and pressure calculation functions.</li>
<li>Register the new bond type.</li>
</ul>
</li>
<li>ScriptInterface:<ul>
<li>Define the <code>ScriptInterface</code> class of the new bond type, which serves as the connection between the C++ core and the Python representation of the bond.</li>
</ul>
</li>
<li>Python interface:<ul>
<li>Import the definition of the interaction struct from the core</li>
<li>Implement a class for the bonded interaction derived from the Python <code>BondedInteraction</code> base class</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="bondedIA_new_struct"></a>
Defining the new interaction</h2>
<p>Every interaction resides in its own source .hpp file. A simple example for a bonded interaction is the FENE bond in <a class="el" href="fene_8hpp.html">fene.hpp</a>. Use this file as template for your new interaction.</p>
<p>The first step is to create a new <code>struct</code> which represents your new bond type inside the .hpp file. It needs to have the following members:</p>
<ul>
<li><div class="fragment"><div class="line"><span class="keyword">static</span> <span class="keyword">constexpr</span> <span class="keywordtype">int</span> num = 1;</div>
</div><!-- fragment --> This is the number of particles involved in the bond, minus 1, i.e. 1 for a pairwise bonded potential such as the FENE bond.</li>
<li><div class="fragment"><div class="line"><span class="keywordtype">double</span> cutoff()<span class="keyword"> const </span>{ <span class="keywordflow">return</span> r0 + drmax; }</div>
</div><!-- fragment --> The return value of <code>cutoff()</code> should be as large as the interaction range of the new interaction. This is only relevant to pairwise bonds. In all other cases, the return value should be 0, namely angle bonds, dihedral bonds as well as other bonds that don't have an interaction range. The <a class="el" href="structVirtualBond.html">VirtualBond</a> is the exception to this rule; its range is <a class="el" href="config_8hpp.html#a4b834391045a7e3c9eebbb4922abffbb">bonded_inactive_cutoff</a> to ensure that it is always skipped by the short-range loop.</li>
<li><div class="fragment"><div class="line">std::optional&lt;Utils::Vector3d&gt; force(<a class="code hl_class" href="classUtils_1_1Vector.html">Utils::Vector3d</a> <span class="keyword">const</span> &amp;<a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">dx</a>) <span class="keyword">const</span>;</div>
<div class="ttc" id="aclassUtils_1_1Vector_html"><div class="ttname"><a href="classUtils_1_1Vector.html">Utils::Vector</a></div><div class="ttdef"><b>Definition</b> <a href="Vector_8hpp_source.html#l00050">Vector.hpp:50</a></div></div>
<div class="ttc" id="acommon__cuda_8cu_html_a2edcfbb6549e85581562bf5ed89d2008"><div class="ttname"><a href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">stream</a></div><div class="ttdeci">cudaStream_t stream[1]</div><div class="ttdoc">CUDA streams for parallel computing on CPU and GPU.</div><div class="ttdef"><b>Definition</b> <a href="common__cuda_8cu_source.html#l00034">common_cuda.cu:34</a></div></div>
</div><!-- fragment --> This function returns the bond force. If it is a bond involving three or four particles, a <code>std::tuple</code> with three or four force vectors has to be returned, respectively.<ul>
<li>The returned value is in a <code>std::optional</code> container if the bond is breakable. If the bond is broken, the returned object is empty; this will stop the integrator with a runtime error.</li>
<li>The function can make use of a pre-calculated distance vector (<code>dx</code>) pointing from particle 2 to particle 1, that takes periodic boundary conditions into account.</li>
<li>The function name and signature may be different, e.g. for angle bonds. To determine the right signature for the new interaction, you can have a look at <a class="el" href="forces__inline_8hpp.html">forces_inline.hpp</a> to see where this function will be called and which other variables may be available for your calculation.</li>
</ul>
</li>
<li><div class="fragment"><div class="line">std::optional&lt;double&gt; energy(<a class="code hl_class" href="classUtils_1_1Vector.html">Utils::Vector3d</a> <span class="keyword">const</span> &amp;<a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">dx</a>) <span class="keyword">const</span>;</div>
</div><!-- fragment --> This function returns the bond energy. The same information as given for the force calculation above applies here. This function will be called from <a class="el" href="energy__inline_8hpp.html">energy_inline.hpp</a> .</li>
<li>A constructor which is used to set all parameters and to do preparatory calculations if necessary, for example <div class="fragment"><div class="line"><a class="code hl_struct" href="structFeneBond.html">FeneBond</a>(<span class="keywordtype">double</span> k, <span class="keywordtype">double</span> drmax, <span class="keywordtype">double</span> r0);</div>
<div class="ttc" id="astructFeneBond_html"><div class="ttname"><a href="structFeneBond.html">FeneBond</a></div><div class="ttdoc">Parameters for FENE bond Potential.</div><div class="ttdef"><b>Definition</b> <a href="fene_8hpp_source.html#l00038">fene.hpp:38</a></div></div>
</div><!-- fragment --> All values the bond needs to function properly should be passed as arguments to this constructor.</li>
</ul>
<h2><a class="anchor" id="bondedIA_new_integration"></a>
Integrating the new bond type into the C++ core</h2>
<p>In most cases, there are three files that need to be updated to integrate the new bond type into the core, namely</p><ul>
<li><a class="el" href="bonded__interaction__data_8hpp.html">bonded_interaction_data.hpp</a></li>
<li><a class="el" href="forces__inline_8hpp.html">forces_inline.hpp</a></li>
<li><a class="el" href="energy__inline_8hpp.html">energy_inline.hpp</a></li>
</ul>
<p>In some cases, you may also need to modify <a class="el" href="pressure__inline_8hpp.html">pressure_inline.hpp</a>.</p>
<ul>
<li>In bonded_interaction_data.cpp:<ul>
<li>Include the header file containing the new bond type.</li>
<li>Add the new bond type to <a class="el" href="bonded__interaction__data_8hpp.html#a915ea8e9c6b81b6c3367aca3b1b55d73">Bonded_IA_Parameters</a> at the end of the types list.</li>
</ul>
</li>
<li>In forces_inline.hpp:<ul>
<li>A call to the new bond's force calculation needs to be placed in either of the functions <a class="el" href="forces__inline_8hpp.html#a64ebeb308b5a25b1d29cb590e5f7792d">calc_bond_pair_force()</a>, <a class="el" href="forces__inline_8hpp.html#aca28321e91d8715d3d1d9f9fa91d5538">calc_bonded_three_body_force()</a> or <a class="el" href="forces__inline_8hpp.html#a7f833faab380e19bb6f7824fb8458596">calc_bonded_four_body_force()</a>, depending on how many bond partners there are.</li>
<li>Add the new entry to the <code>if</code> - <code>else</code> chain, like in the following example <div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> <span class="keyword">const</span> *<a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">iap</a> = std::get_if&lt;QuarticBond&gt;(&amp;<a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">iaparams</a>)) {</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">iap</a>-&gt;force(<a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">dx</a>);</div>
<div class="line">}</div>
<div class="line"><span class="comment">// ...</span></div>
</div><!-- fragment --></li>
</ul>
</li>
<li>In energy_inline.hpp:<ul>
<li>A call to the new bond's force calculation needs to be placed in <a class="el" href="energy__inline_8hpp.html#a0e7801bac293944a1754a8d07388fb2b">calc_bonded_energy</a>. Find the <code>if</code> - <code>else</code> chain that corresponds to the correct number of bond partners.</li>
<li>Add the new entry to the <code>if</code> - <code>else</code> chain, like in the following example <div class="fragment"><div class="line"><span class="comment">// ...</span></div>
<div class="line"><span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="keyword">auto</span> <span class="keyword">const</span> *<a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">iap</a> = std::get_if&lt;QuarticBond&gt;(&amp;<a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">iaparams</a>)) {</div>
<div class="line">  <span class="keywordflow">return</span> <a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">iap</a>-&gt;energy(<a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">dx</a>);</div>
<div class="line">}</div>
<div class="line"><span class="comment">// ...</span></div>
</div><!-- fragment --></li>
</ul>
</li>
<li>Pressure tensor and virial calculation (pressure_inline.hpp): if your bonded interaction is not a pair bond or modifies the particles involved, you have to implement a custom solution for virial calculation. The pressure occurs twice, once for the parallelized isotropic pressure and once for the tensorial pressure calculation. For pair forces, the pressure is calculated using the virials; for many body interactions, currently no pressure is calculated.</li>
</ul>
<p>Note that the force and energy functions cannot alter the particle states.</p>
<h2><a class="anchor" id="bondedIA_new_script_interface"></a>
Registering the new interaction in the ScriptInterface</h2>
<ul>
<li>In src/script_interface/interactions/BondedInteraction.hpp: Add a new class representing your new bond type in the <code>ScriptInterface</code>.<ul>
<li>We recommend that the new class has the same name as the interaction in the core.</li>
<li>You can use <a class="el" href="classScriptInterface_1_1Interactions_1_1FeneBond.html">ScriptInterface::Interactions::FeneBond</a> as a template.</li>
<li>The class must be derived from <a class="el" href="classScriptInterface_1_1Interactions_1_1BondedInteraction.html">ScriptInterface::Interactions::BondedInteraction</a>.</li>
<li>It is recommended to include the statement <div class="fragment"><div class="line"><span class="keyword">using </span>CoreBondedInteraction = <a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">::YourNewBond</a>;</div>
</div><!-- fragment --> where <code>YourNewBond</code> is the core type you defined.</li>
<li>Implement a member function with the signature <div class="fragment"><div class="line"><span class="keywordtype">void</span> construct_bond(VariantMap <span class="keyword">const</span> &amp;<a class="code hl_variable" href="steepest__descent_8cpp.html#a7c810f3a2b554c3abe0c472e66645420">params</a>)<span class="keyword"> override </span>{ <span class="comment">/* ... */</span> }</div>
<div class="ttc" id="asteepest__descent_8cpp_html_a7c810f3a2b554c3abe0c472e66645420"><div class="ttname"><a href="steepest__descent_8cpp.html#a7c810f3a2b554c3abe0c472e66645420">params</a></div><div class="ttdeci">static SteepestDescentParameters params</div><div class="ttdoc">Currently active steepest descent instance.</div><div class="ttdef"><b>Definition</b> <a href="steepest__descent_8cpp_source.html#l00044">steepest_descent.cpp:44</a></div></div>
</div><!-- fragment --> In this function, the member <code>m_bonded_ia</code> shall be initialized using the parameters that are given in <code>params</code>. Use the <code>construct_bond()</code> method of <code>FeneBond</code> as a template. An instance of the core type <code>YourNewBond</code> should be initialized, which is then used to initialize a <code>std::shared_ptr</code> to a <a class="el" href="bonded__interaction__data_8hpp.html#a915ea8e9c6b81b6c3367aca3b1b55d73">Bonded_IA_Parameters</a>, which is then assigned to <code>m_bonded_ia</code>. The values of the parameters are extracted from <code>params</code> using <div class="fragment"><div class="line"><a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">get_value&lt;parameter_type&gt;</a>(<a class="code hl_variable" href="steepest__descent_8cpp.html#a7c810f3a2b554c3abe0c472e66645420">params</a>, <span class="stringliteral">&quot;parameter_name&quot;</span>)</div>
</div><!-- fragment --> where <code>parameter_type</code> is the type of the parameter, e.g. <code>double</code> or <code>int</code> or even <code>std::string</code>, and <code>"parameter_name"</code> must be replaced by the name of the respective parameter. This name must be the same as in the Python interface, but may differ from the name in the core interaction type. It is, however, recommended to use the same names for both the Python interface and the ESPResSo core for consistency whenever possible.</li>
<li>Implement the constructor. We recommend to adapt it from <code>FeneBond</code>. All it needs to do is to register its parameters so they can be set from Python. For this purpose, call <div class="fragment"><div class="line">add_parameters(<span class="comment">/* ... */</span>);</div>
</div><!-- fragment --> inside the constructor. It expects a vector of <a class="el" href="structScriptInterface_1_1AutoParameter.html">ScriptInterface::AutoParameter</a>. Usually, this vector is initialized using an initializer list, each element of which is in itself a list which initializes one instance of <code>AutoParameter</code> (see <a class="el" href="AutoParameter_8hpp.html">AutoParameter.hpp</a>). One of many ways to initialize these parameters is to pass the parameter name as a string, a custom setter and a custom getter function. The parameters are typically made read-only by passing <code>AutoParameter::read_only</code> instead of a setter function. The getter function can be a lambda function, which is directly passed to the constructor.</li>
</ul>
</li>
<li>In src/script_interface/interactions/initialize.cpp: Your new interaction type needs to be registered here so that the <code>ScriptInterface</code> can find it by its name. In the function <code>initialize</code> add a new line of the form <div class="fragment"><div class="line"><a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">om</a>-&gt;register_new&lt;<a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">YourNewBond</a>&gt;(<span class="stringliteral">&quot;Interactions::YourNewBond&quot;</span>);</div>
</div><!-- fragment --> where <code>YourNewBond</code> must be replaced by the name of your new bond type. The string is used to match the <code>ScriptInterface</code> class with the Python class (see below).</li>
</ul>
<h2><a class="anchor" id="bondedIA_new_interface"></a>
Adding the interaction in the Python interface</h2>
<ul>
<li>In file <code>src/python/espressomd/interactions.py</code>:<ul>
<li>Add the bonded interaction to <code>BONDED_IA</code>. The order of the enum values must match the order of types in <a class="el" href="bonded__interaction__data_8hpp.html#a915ea8e9c6b81b6c3367aca3b1b55d73">Bonded_IA_Parameters</a> exactly: <div class="fragment"><div class="line"><span class="keyword">class </span><a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">BONDED_IA</a>(<a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">enum.IntEnum</a>):</div>
<div class="line">    NONE = 0</div>
<div class="line">    FENE = <a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">enum.auto</a>()</div>
<div class="line">    HARMONIC = <a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">enum.auto</a>()</div>
<div class="line">    <span class="comment"># ...</span></div>
</div><!-- fragment --></li>
<li>Implement the Python class for the bonded interaction, using the one for the FENE bond as template. Please use pep8 naming convention.</li>
<li>Set the class' members <div class="fragment"><div class="line">_so_name = <span class="stringliteral">&quot;Interactions::YourNewBond&quot;</span></div>
<div class="line">_type_number = <a class="code hl_variable" href="common__cuda_8cu.html#a2edcfbb6549e85581562bf5ed89d2008">BONDED_IA.YOURNEWBOND</a></div>
</div><!-- fragment --> where you put the name of your bond instead of <code>YourNewBond</code>. This connects the <code>ScriptInterface</code> class with the Python class. The type number is the new enum value from <code>BONDED_IA</code>.</li>
</ul>
</li>
<li>In file <code>testsuite/python/interactions_bonded_interface.py</code>:<ul>
<li>Add a test case to verify that parameters set and gotten from the interaction are consistent.</li>
</ul>
</li>
<li>In file <code>testsuite/python/interactions_bonded.py</code> or <code>testsuite/python/interactions_bond_angle.py</code> or <code>testsuite/python/interactions_dihedral.py</code>:<ul>
<li>Add a test case to verify the forces and energies are correct.</li>
</ul>
</li>
</ul>
<h1><a class="anchor" id="bondedIA_bond_angles"></a>
Bond angle potentials</h1>
<h2><a class="anchor" id="bondedIA_angle_force"></a>
General expressions for the forces</h2>
<p>This section uses the particle force expressions derived in <a class="el" href="citelist.html#CITEREF_swope92a">[43]</a>.</p>
<p>The gradient of the potential at particle \( i \) is given by the chain rule in equation 6:</p>
<p class="formulaDsp">
\begin{equation}
    \label{eq:Swope-eq-6}
    \nabla_i U(\theta_{ijk})
        = \left(
                \frac{\mathrm{d}U(\theta_{ijk})}{\mathrm{d}\theta_{ijk}}
          \right)
          \left(
                \frac{\mathrm{d}\theta_{ijk}}{\mathrm{d}\cos(\theta_{ijk})}
          \right)
          \left(
                \nabla_i \cos(\theta_{ijk})
          \right)
\end{equation}
</p>
<p>with</p>
<p class="formulaDsp">
\[
    \left(
          \frac{\mathrm{d}\theta_{ijk}}{\mathrm{d}\cos(\theta_{ijk})}
    \right)
        = \left(
                \frac{-1}{\sin(\theta_{ijk})}
          \right)
\]
</p>
<p>and \( \theta_{ijk} \) the angle formed by the three particles, \( U(\theta_{ijk}) \) the bond angle potential, \( \vec{r_{ij}} \) the vector from particle \( j \) to particle \( i \) and \( \nabla_i \) the gradient in the direction \( \vec{r_{ij}} \).</p>
<p>The expression for \( \cos(\theta_{ijk}) \) is given by equation 4:</p>
<p class="formulaDsp">
\begin{equation}
    \label{eq:Swope-eq-4}
    \cos(\theta_{ijk})
        = \frac{\vec{r_{ij}}\cdot\vec{r_{kj}}}
               {\left\|\vec{r_{ij}}\right\|\left\|\vec{r_{kj}}\right\|}
\end{equation}
</p>
<p>The expression for its gradient is given by equation 9:</p>
<p class="formulaDsp">
\begin{equation}
    \label{eq:Swope-eq-9}
    \nabla_i \cos(\theta_{ijk})
        = \vec{e_x}\frac{\partial\cos(\theta_{ijk})}{\partial x_{ij}}
        + \vec{e_y}\frac{\partial\cos(\theta_{ijk})}{\partial y_{ij}}
        + \vec{e_z}\frac{\partial\cos(\theta_{ijk})}{\partial z_{ij}}
\end{equation}
</p>
<p>with \( \left(\vec{e_x}, \vec{e_y}, \vec{e_z}\right) \) the unit vectors of the reference coordinate system and \( \vec{r_{ij}} = \left(x_{ij}, y_{ij}, z_{ij}\right) \).</p>
<p>Applying the quotient rule:</p>
<p class="formulaDsp">
\[
    \frac{\partial\cos(\theta_{ijk})}{\partial x_{ij}}
        = \frac{\partial}{\partial x_{ij}}
          \left(
                \frac{\vec{r_{ij}}\cdot\vec{r_{kj}}}
                     {\left\|\vec{r_{ij}}\right\|\left\|\vec{r_{kj}}\right\|}
          \right)
        = \frac{\left\|\vec{r_{ij}}\right\|\left\|\vec{r_{kj}}\right\|
                \partial \left(\vec{r_{ij}}\cdot\vec{r_{kj}}\right)
              /\, \partial x_{ij}
              - \vec{r_{ij}}\cdot\vec{r_{kj}}\cdot
                \partial
                \left(
                     \left\|\vec{r_{ij}}\right\|\left\|\vec{r_{kj}}\right\|
                \right)
              /\, \partial x_{ij}}
               {\left\|\vec{r_{ij}}\right\|^2\left\|\vec{r_{kj}}\right\|^2}
\]
</p>
<p>with</p>
<p class="formulaDsp">
\[
    \frac{\partial \left(\vec{r_{ij}}\cdot\vec{r_{kj}}\right)}
         {\partial x_{ij}}
        = \frac{\partial \left(x_{ij} \cdot x_{kj} + y_{ij} \cdot y_{kj} + z_{ij} \cdot z_{kj}\right)}
         {\partial x_{ij}}
        = x_{kj}
\]
</p>
<p>and</p>
<p class="formulaDsp">
\[
    \frac{\partial \left(\left\|\vec{r_{ij}}\right\|\left\|\vec{r_{kj}}\right\|\right)}
         {\partial x_{ij}}
        = \left\|\vec{r_{kj}}\right\|
          \frac{\partial}{\partial x_{ij}}
          \sqrt{x_{ij}^2 + y_{ij}^2 + z_{ij}^2}
        = \left\|\vec{r_{kj}}\right\|
          \frac{0.5 \cdot 2 \cdot x_{ij}}
               {\sqrt{x_{ij}^2 + y_{ij}^2 + z_{ij}^2}}
        = x_{ij}
          \frac{\left\|\vec{r_{kj}}\right\|}
               {\left\|\vec{r_{ij}}\right\|}
\]
</p>
<p>leading to equation 12:</p>
<p class="formulaDsp">
\begin{align*}
    \label{eq:Swope-eq-12}
    \frac{\partial\cos(\theta_{ijk})}{\partial x_{ij}}
       &amp;= \frac{\left\|\vec{r_{ij}}\right\|\left\|\vec{r_{kj}}\right\|x_{kj}
                - \vec{r_{ij}}\cdot\vec{r_{kj}}\cdot x_{ij}
                  \left\|\vec{r_{kj}}\right\|\left\|\vec{r_{ij}}\right\|^{-1}}
               {\left\|\vec{r_{ij}}\right\|^2\left\|\vec{r_{kj}}\right\|^2}
    \\
       &amp;= \frac{x_{kj}}
               {\left\|\vec{r_{ij}}\right\|\left\|\vec{r_{kj}}\right\|}
        - \frac{\vec{r_{ij}}\cdot\vec{r_{kj}}\cdot x_{ij}}
               {\left\|\vec{r_{ij}}\right\|^3\left\|\vec{r_{kj}}\right\|}
    \\
       &amp;= \frac{1}{\left\|\vec{r_{ij}}\right\|}
               \left(
                  \frac{x_{kj}}{\left\|\vec{r_{kj}}\right\|}
                - \frac{x_{ij}}{\left\|\vec{r_{ij}}\right\|}
                  \cos(\theta_{ijk})
               \right)
\end{align*}
</p>
<p>Applying these steps to equations 9-11 leads to the force equations for all three particles:</p>
<p class="formulaDsp">
\begin{align*}
    \vec{F_i}
        &amp;= - K(\theta_{ijk})
               \frac{1}{\left\|\vec{r_{ij}}\right\|}
               \left(
                  \frac{\vec{r_{kj}}}{\left\|\vec{r_{kj}}\right\|}
                - \frac{\vec{r_{ij}}}{\left\|\vec{r_{ij}}\right\|}
                  \cos(\theta_{ijk})
               \right)
    \\
    \vec{F_k}
        &amp;= - K(\theta_{ijk})
               \frac{1}{\left\lVert\vec{r_{kj}}\right\rVert}
               \left(
                  \frac{\vec{r_{ij}}}{\left\|\vec{r_{ij}}\right\|}
                - \frac{\vec{r_{kj}}}{\left\|\vec{r_{kj}}\right\|}
                  \cos(\theta_{ijk})
               \right)
    \\
    \vec{F_j} &amp;= -\left(\vec{F_i} + \vec{F_k}\right)
\end{align*}
</p>
<p>with \( K(\theta_{ijk}) \) the angle force term, which depends on the expression used for the angle potential. Forces \( \vec{F_i} \) and \( \vec{F_k} \) are perpendicular to the displacement vectors \( \vec{r_{ij}} \) resp. \( \vec{r_{kj}} \) and their magnitude are proportional to the potential gradient normalized by the displacement vectors:</p>
<p class="formulaDsp">
\begin{align*}
    \left\|\vec{F_i}\right\|
        &amp;= \left(
                \frac{\mathrm{d}U(\theta_{ijk})}{\mathrm{d}\theta_{ijk}}
           \right)
           \frac{1}{\left\|\vec{r_{ij}}\right\|}
    \\
    \left\|\vec{F_k}\right\|
        &amp;= \left(
                \frac{\mathrm{d}U(\theta_{ijk})}{\mathrm{d}\theta_{ijk}}
           \right)
           \frac{1}{\left\|\vec{r_{kj}}\right\|}
\end{align*}
</p>
<h2><a class="anchor" id="bondedIA_angle_potentials"></a>
Available potentials</h2>
<h3><a class="anchor" id="bondedIA_angle_harmonic"></a>
Harmonic angle potential</h3>
<p>The harmonic angle potential takes the form:</p>
<p class="formulaDsp">
\begin{equation}
    \label{eq:harmonic-angle-pot}
    U(\theta_{ijk})
        = \frac{1}{2}k_{ijk}\left[\theta_{ijk} - \theta_{ijk}^0\right]^2
\end{equation}
</p>
<p>with \( \theta_{ijk} \) the angle formed by the three particles, \( \theta_{ijk}^0 \) the equilibrium angle and \( k_{ijk} \) the bond angle force constant.</p>
<p>The derivative with respect to the angle is:</p>
<p class="formulaDsp">
\[
    \frac{\mathrm{d}U(\theta_{ijk})}{\mathrm{d}\theta_{ijk}}
        = k_{ijk}\left[\theta_{ijk} - \theta_{ijk}^0\right]
\]
</p>
<p>resulting in the following angle force term:</p>
<p class="formulaDsp">
\begin{equation}
    \label{eq:harmonic-angle-pot-angle-term}
    K(\theta_{ijk})
        = -k_{ijk}\frac{\theta_{ijk} - \theta_{ijk}^0}
                       {\sin(\theta_{ijk})}
\end{equation}
</p>
<p>which can lead to numerical instability at \( \theta_{ijk} = 0 \) and \( \theta_{ijk} = \pi \).</p>
<h3><a class="anchor" id="bondedIA_angle_cossquare"></a>
Harmonic cosine potential</h3>
<p>The harmonic cosine potential takes the form:</p>
<p class="formulaDsp">
\begin{equation}
    \label{eq:harmonic-cosine-pot}
    U(\theta_{ijk})
        = \frac{1}{2}
          k_{ijk}\left[\cos(\theta_{ijk}) - \cos(\theta_{ijk}^0)\right]^2
\end{equation}
</p>
<p>with \( \theta_{ijk} \) the angle formed by the three particles, \( \theta_{ijk}^0 \) the equilibrium angle and \( k_{ijk} \) the bond angle force constant.</p>
<p>The derivative with respect to the angle is:</p>
<p class="formulaDsp">
\[
    \frac{\mathrm{d}U(\theta_{ijk})}{\mathrm{d}\theta_{ijk}}
        = -k_{ijk}\sin(\theta_{ijk})
          \left[\cos(\theta_{ijk}) - \cos(\theta_{ijk}^0)\right]
\]
</p>
<p>resulting in the following angle force term:</p>
<p class="formulaDsp">
\begin{equation}
    \label{eq:harmonic-cosine-pot-angle-term}
    K(\theta_{ijk})
        = k_{ijk}\left[\cos(\theta_{ijk}) - \cos(\theta_{ijk}^0)\right]
\end{equation}
</p>
<p>which does not suffer from numerical instability.</p>
<h3><a class="anchor" id="bondedIA_angle_cosine"></a>
Cosine potential</h3>
<p>The cosine potential takes the form:</p>
<p class="formulaDsp">
\begin{equation}
    \label{eq:cosine-pot}
    U(\theta_{ijk})
        = k_{ijk}\left[1 - \cos(\theta_{ijk} - \theta_{ijk}^0)\right]
\end{equation}
</p>
<p>with \( \theta_{ijk} \) the angle formed by the three particles, \( \theta_{ijk}^0 \) the equilibrium angle and \( k_{ijk} \) the bond angle force constant.</p>
<p>The derivative with respect to the angle is:</p>
<p class="formulaDsp">
\[
    \frac{\mathrm{d}U(\theta_{ijk})}{\mathrm{d}\theta_{ijk}}
        = k_{ijk}\sin(\theta_{ijk} - \theta_{ijk}^0)
\]
</p>
<p>resulting in the following angle force term:</p>
<p class="formulaDsp">
\begin{equation}
    \label{eq:cosine-pot-angle-term}
    K(\theta_{ijk})
        = -k_{ijk}\frac{\sin(\theta_{ijk} - \theta_{ijk}^0)}
                       {\sin(\theta_{ijk})}
\end{equation}
</p>
<p>which can lead to numerical instability at \( \theta_{ijk} = 0 \) and \( \theta_{ijk} = \pi \).</p>
<h3><a class="anchor" id="bondedIA_angle_tab"></a>
Tabulated potential</h3>
<p>The tabulated potential and its derivative with respect to the angle are provided by the user. The angle force term takes the form:</p>
<p class="formulaDsp">
\begin{equation}
    \label{eq:tabulated-pot-angle-term}
    K(\theta_{ijk})
        = \frac{-1}{\sin(\theta_{ijk})}
          \left(
                \frac{\mathrm{d}U(\theta_{ijk})}{\mathrm{d}\theta_{ijk}}
          \right)
\end{equation}
</p>
<p>which can lead to numerical instability at \( \theta_{ijk} = 0 \) and \( \theta_{ijk} = \pi \). </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Sat Nov 1 2025 02:27:00 for ESPResSo by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
